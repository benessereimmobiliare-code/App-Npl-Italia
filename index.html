<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceleratore Immobiliare</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; overflow-x: hidden; }
        html { overflow-x: hidden; }
        
        /* TOP NAV */
        .top-bar { background: white; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-wrap: wrap; gap: 15px; }
        .logo { color: #667eea; font-weight: 700; font-size: 16px; }
        .area-btn { padding: 8px 16px; border: 2px solid #ddd; border-radius: 10px; font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; line-height: 1.3; background: white; transition: all 0.3s; }
        .area-btn small { font-size: 9px; font-weight: 500; display: block; margin-top: 2px; }
        .area-free { background: #4CAF50; color: white; border-color: #4CAF50; }
        .area-lock { opacity: 0.6; }
        .area-lock:hover { opacity: 1; transform: scale(1.05); }
        .top-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .top-btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-grn { background: #4CAF50; color: white; }
        .btn-org { background: #FF9800; color: white; }
        .btn-red { background: #f44336; color: white; }
        
        /* HEADER STATS */
        .hero { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 50px 30px; text-align: center; }
        .hero h1 { font-size: 2.2em; margin-bottom: 8px; }
        .hero p { opacity: 0.95; margin-bottom: 35px; }
        .stats { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
        .stat { background: rgba(255,255,255,0.15); padding: 18px 25px; border-radius: 10px; min-width: 130px; }
        .stat-num { font-size: 28px; font-weight: 700; }
        .stat-lbl { font-size: 12px; opacity: 0.9; margin-top: 4px; }
        
        /* AFFARI PRONTI */
        .affari { background: #1a1f3a; color: white; padding: 45px 30px; }
        .affari-wrap { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr 280px; gap: 35px; align-items: center; }
        .affari h2 { font-size: 1.9em; margin-bottom: 18px; }
        .affari p { line-height: 1.6; margin-bottom: 12px; }
        .affari ul { list-style: none; margin: 18px 0; }
        .affari li { padding: 6px 0 6px 22px; position: relative; }
        .affari li:before { content: '✓'; position: absolute; left: 0; color: #4CAF50; font-weight: 700; }
        .btn-big { background: #FFC107; color: #000; padding: 14px 28px; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; }
        .box-gold { background: rgba(255,255,255,0.1); padding: 18px; border-radius: 10px; text-align: center; }
        
        /* FILTRI */
        .filtri { background: white; padding: 28px 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filtri h3 { color: #667eea; margin-bottom: 18px; font-size: 1.4em; }
        .filtri-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .filtri-grid select, .filtri-grid input { padding: 11px; border: 2px solid #ddd; border-radius: 7px; width: 100%; }
        .btn-filtri { display: flex; gap: 8px; }
        
        /* CORSI */
        .corsi { padding: 45px 30px; background: #fafafa; }
        .corsi h3 { text-align: center; font-size: 1.7em; margin-bottom: 35px; color: #333; }
        .corsi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; max-width: 1100px; margin: 0 auto; }
        .card { background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .card-ico { padding: 35px; text-align: center; font-size: 55px; }
        .card-txt { background: white; padding: 22px; }
        .card-txt h4 { font-size: 1.2em; margin-bottom: 8px; color: #333; }
        .card-txt p { color: #666; margin-bottom: 12px; line-height: 1.4; }
        .btn-gratis { background: #4CAF50; color: white; padding: 9px 18px; border: none; border-radius: 7px; font-weight: 700; cursor: pointer; }
        
        /* TABELLA */
        .tbl-sec { padding: 35px 30px; background: white; }
        .tbl-sec h3 { font-size: 1.7em; margin-bottom: 25px; color: #333; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1000px; }
        thead { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        th { padding: 12px 10px; text-align: left; font-weight: 600; white-space: nowrap; font-size: 11px; }
        td { padding: 10px; border-bottom: 1px solid #e5e5e5; font-size: 12px; }
        tr:hover { background: #f9f9f9; }
        .badge { padding: 5px 10px; border-radius: 5px; font-weight: 700; font-size: 11px; color: white; display: inline-block; }
        .badge-asta { background: #FF9800; }
        .badge-npl { background: #2196F3; }
        .btn-det { background: #FFC107; color: #000; padding: 7px 14px; border: none; border-radius: 7px; font-weight: 700; cursor: pointer; font-size: 11px; white-space: nowrap; }
        
        /* BLUR */
        .blur-wrap { position: relative; margin-top: 18px; }
        .blur-tbl { filter: blur(4px); opacity: 0.25; }
        .blur-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.97); padding: 35px; border-radius: 12px; text-align: center; box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
        .blur-over h3 { color: #667eea; font-size: 1.6em; margin-bottom: 12px; }
        .btn-prem { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 13px 30px; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; }
        
        /* LOGIN */
        .login-scr { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea, #764ba2); }
        .login-box { background: white; padding: 38px; border-radius: 18px; box-shadow: 0 18px 55px rgba(0,0,0,0.3); max-width: 380px; width: 100%; }
        .login-box h1 { color: #667eea; margin-bottom: 28px; text-align: center; }
        .inp-grp { margin-bottom: 18px; }
        .inp-grp input { width: 100%; padding: 11px; border: 2px solid #ddd; border-radius: 7px; font-size: 15px; }
        .btn-log { width: 100%; padding: 13px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
        
        /* ADMIN */
        .admin { background: #fff; padding: 28px 30px; margin: 0 30px 18px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); z-index: 999; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal.show { display: flex; }
        .modal-box { background: white; padding: 28px; border-radius: 12px; max-width: 850px; width: 100%; max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid #e5e5e5; position: sticky; top: 0; background: white; z-index: 1; }
        .det-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
        .det-item { padding: 11px; background: #f9f9f9; border-radius: 7px; word-break: break-word; }
        .det-item label { display: block; font-size: 10px; color: #666; margin-bottom: 4px; text-transform: uppercase; font-weight: 600; }
        .det-item .val { font-size: 13px; color: #333; font-weight: 500; }
        
        .hide { display: none !important; }
        .load { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .load.show { display: flex; }
        .spin { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 45px; height: 45px; animation: sp 1s linear infinite; }
        @keyframes sp { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* RESPONSIVE MOBILE */
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .top-bar { padding: 10px 10px; flex-direction: column; align-items: flex-start; }
            .logo { margin-bottom: 10px; font-size: 14px; }
            .area-btn { padding: 8px 10px; font-size: 9px; min-height: 44px; /* touch area */ }
            .area-btn small { font-size: 7px; }
            .top-btns { width: 100%; justify-content: space-between; flex-wrap: wrap; gap: 5px; }
            .top-btn { padding: 8px 12px; font-size: 10px; min-height: 40px; /* touch area */ }
            #badge { font-size: 10px; padding: 6px 10px; }
            
            .hero { padding: 25px 10px; }
            .hero h1 { font-size: 1.4em; }
            .hero p { font-size: 13px; }
            .stats { gap: 12px; padding: 0 10px; }
            .stat { padding: 12px 15px; min-width: 90px; }
            .stat-num { font-size: 20px; }
            .stat-lbl { font-size: 9px; }
            
            .affari { padding: 25px 10px; }
            .affari-wrap { grid-template-columns: 1fr; gap: 20px; }
            .affari h2 { font-size: 1.3em; }
            .affari p { font-size: 13px; }
            .btn-big { padding: 12px 20px; font-size: 13px; min-height: 44px; /* touch area */ }
            
            .corsi { padding: 25px 10px; }
            .corsi h3 { font-size: 1.2em; }
            .corsi-grid { grid-template-columns: 1fr; gap: 15px; }
            .btn-gratis { padding: 10px 18px; min-height: 44px; /* touch area */ }
            
            .filtri { padding: 18px 10px; }
            .filtri h3 { font-size: 1.1em; }
            .filtri-grid { grid-template-columns: 1fr; gap: 10px; }
            .filtri-grid select, .filtri-grid input { min-height: 44px; font-size: 16px; /* iOS zoom fix */ }
            
            .tbl-sec { padding: 18px 8px; }
            .tbl-sec h3 { font-size: 1.2em; margin-bottom: 10px; }
            table { font-size: 10px; min-width: 700px; }
            th { padding: 8px 5px; font-size: 9px; }
            td { padding: 8px 5px; font-size: 10px; }
            .btn-det { padding: 6px 10px; font-size: 10px; min-height: 36px; /* touch area */ }
            
            .modal { padding: 10px; }
            .modal-box { padding: 15px; margin: 5px; max-height: 85vh; }
            .modal-head h2 { font-size: 1.1em; }
            .det-grid { grid-template-columns: 1fr; gap: 8px; }
            .det-item { padding: 10px; }
            .btn-red { min-height: 44px; /* touch area */ }
            
            .admin { padding: 15px 10px; margin: 0 10px 10px; }
            #fileInp { min-height: 44px; /* touch area */ }
            
            .login-box { padding: 20px; margin: 10px; }
            .login-box h1 { font-size: 1.2em; }
            .inp-grp input { min-height: 44px; font-size: 16px; /* iOS zoom fix */ }
            .btn-log { min-height: 44px; /* touch area */ }
        }
        
        @media (max-width: 480px) {
            .hero h1 { font-size: 1.1em; }
            .stats { flex-direction: column; gap: 10px; }
            .stat { width: 100%; max-width: 100%; }
            .area-btn { font-size: 8px; padding: 6px 8px; }
            table { font-size: 9px; min-width: 600px; }
            th, td { padding: 6px 4px; }
        }
    </style>
</head>
<body>
    <div id="load" class="load"><div style="background:white;padding:35px;border-radius:12px;text-align:center;"><div class="spin"></div><p id="loadTxt" style="margin-top:18px;font-weight:600;">Caricamento...</p></div></div>

    <div id="loginScr" class="login-scr">
        <div class="login-box">
            <h1>🚀 Acceleratore Immobiliare</h1>
            <div id="loginAlert"></div>
            <div class="inp-grp"><input type="text" id="user" placeholder="Username"></div>
            <div class="inp-grp"><input type="password" id="pass" placeholder="Password"></div>
            <button class="btn-log" onclick="doLogin()">Accedi</button>
        </div>
    </div>

    <div id="app" class="hide">
        <div class="top-bar">
            <div class="logo">🚀 Acceleratore Immobiliare</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button class="area-btn area-free">✓<br>Area FREE<br><small>Attivo</small></button>
                <button class="area-btn area-lock">🔒<br>Area Premium<br><small>UPGRADE</small></button>
                <button class="area-btn area-lock">🔒<br>Progetto 100 Soci<br><small>VIP</small></button>
                <button class="area-btn area-lock">💰<br>Area Esperti<br><small>PRO</small></button>
            </div>
            <div class="top-btns">
                <span id="badge" style="padding:8px 16px;background:#f0f0f0;border-radius:18px;font-weight:600;font-size:12px;"></span>
                <button class="top-btn btn-grn hide" id="btnUp" onclick="toggleAdmin()">Carica Excel</button>
                <button class="top-btn btn-org hide" id="btnDel" onclick="delDB()">Svuota DB</button>
                <button class="top-btn btn-red" onclick="doLogout()">Esci</button>
            </div>
        </div>

        <div id="adminPan" class="admin hide">
            <h3 style="color:#667eea;margin-bottom:12px;">📊 Upload Excel</h3>
            <div id="upAlert"></div>
            <input type="file" id="fileInp" accept=".xlsx,.xls" onchange="upFile(event)">
            <p style="margin-top:8px;color:#666;font-size:12px;">Carica prima ASTE poi NPL</p>
        </div>

        <div class="hero">
            <h1>🏠 Acceleratore Immobiliare</h1>
            <p>Accelera i tuoi risultati in Aste e NPL – Da zero a PRO</p>
            <div class="stats">
                <div class="stat"><div class="stat-num" id="sAste">0</div><div class="stat-lbl">📊 Aste Attive</div></div>
                <div class="stat"><div class="stat-num" id="sNPL">0</div><div class="stat-lbl">📋 NPL Disponibili</div></div>
                <div class="stat"><div class="stat-num">247</div><div class="stat-lbl">⭐ Utenti Premium</div></div>
                <div class="stat"><div class="stat-num">38</div><div class="stat-lbl">💼 Esperti Attivi</div></div>
                <div class="stat"><div class="stat-num">€4.2M</div><div class="stat-lbl">💰 Capitale Disponibile</div></div>
            </div>
        </div>

        <div class="affari">
            <div class="affari-wrap">
                <div>
                    <h2>💼 Affari Pronti</h2>
                    <p><strong>Sei un investitore super impegnato</strong> dalla mattina alla sera ma vuoi sfruttare la capacità degli iscritti all'<strong>Area Esperti</strong> del nostro Acceleratore?</p>
                    <p>Usufruirai a <strong>costo zero</strong> del "<strong>Servizio Selezione Esperti Investitori Immobiliari</strong>" con:</p>
                    <ul>
                        <li>Analisi accurata del titolare esperto</li>
                        <li>Rating verificato</li>
                        <li>Analisi regole di ingaggio</li>
                        <li>Messa in contatto diretto investitore-esperto</li>
                    </ul>
                    <button class="btn-big">📝 COMPILA IL QUESTIONARIO</button>
                    <p style="margin-top:12px;font-size:12px;opacity:0.85;">ℹ️ <strong>IMPORTANTE:</strong> Questo NON è un servizio di investimento, ma esclusivamente un servizio di messa in contatto diretto tra investitori ed esperti del settore immobiliare.</p>
                </div>
                <div class="box-gold">
                    <div style="font-size:55px;margin-bottom:8px;">🤝</div>
                    <div><strong>Investitori 🤝 Esperti</strong></div>
                    <div style="font-size:12px;margin-top:8px;opacity:0.9;">Servizio gratuito di matching</div>
                </div>
            </div>
        </div>

        <div class="corsi">
            <h3>📚 Corsi Gratuiti per Iniziare</h3>
            <div class="corsi-grid">
                <div class="card">
                    <div class="card-ico">🎓</div>
                    <div class="card-txt">
                        <h4>Come Funzionano le Aste Immobiliari</h4>
                        <p>Impara le basi delle aste giudiziarie.</p>
                        <button class="btn-gratis">GRATIS</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-ico">💰</div>
                    <div class="card-txt">
                        <h4>Valutare un NPL in 10 Minuti</h4>
                        <p>Metodo rapido per capire se un credito è opportunità o trappola.</p>
                        <button class="btn-gratis">GRATIS</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-ico">📝</div>
                    <div class="card-txt">
                        <h4>5 Errori da Evitare</h4>
                        <p>Gli sbagli più comuni dei principianti.</p>
                        <button class="btn-gratis">GRATIS</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="filtri">
            <h3>🔍 Filtri di Ricerca</h3>
            <div class="filtri-grid">
                <select id="fTipo"><option value="">Tutti</option><option value="Asta">Aste</option><option value="NPL">NPL</option></select>
                <select id="fReg" onchange="updCitta()"><option value="">Tutte le regioni</option></select>
                <select id="fCit"><option value="">Tutte le città</option></select>
                <input type="text" id="fSearch" placeholder="Cerca...">
            </div>
            <div class="btn-filtri">
                <button class="top-btn btn-grn" onclick="appFilt()">✅ Applica Filtri</button>
                <button class="top-btn btn-red" onclick="clrFilt()">🗑️ Azzera Filtri</button>
            </div>
        </div>

        <div class="tbl-sec">
            <h3 id="tblTitle">🔨 Aste Disponibili</h3>
            <p style="margin-bottom:15px;color:#666;font-size:14px;">Totale: <strong id="recordCount">0</strong> risultati</p>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05);">
                <table id="mainTable">
                    <thead id="tblHead">
                        <tr><th>Tipo</th><th>Regione</th><th>Comune</th><th>Indirizzo</th><th>Prezzo Base Asta</th><th>Data Asta</th><th>Azioni</th></tr>
                    </thead>
                    <tbody id="tblBody"><tr><td colspan="7" style="text-align:center;padding:35px;">Carica dati...</td></tr></tbody>
                </table>
            </div>
            <p style="font-size:11px;color:#666;margin-top:8px;text-align:center;">📱 Scorri orizzontalmente per vedere tutte le colonne</p>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h2>Dettaglio</h2>
                <button class="btn-red" onclick="clsMod()" style="padding:7px 14px;border:none;border-radius:7px;font-weight:600;cursor:pointer;">Chiudi</button>
            </div>
            <div id="detCont" class="det-grid"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        let db, allData = [], usr = null, fbOk = false;
        const usrs = {'admin': {pw: 'admin2025', rol: 'Admin', lvl: 3}};

        function shLd(t = 'Caricamento...') { document.getElementById('loadTxt').textContent = t; document.getElementById('load').classList.add('show'); }
        function hdLd() { document.getElementById('load').classList.remove('show'); }

        async function initFB() {
            if (fbOk) return;
            return new Promise((ok, err) => {
                let n = 0;
                function go() {
                    n++;
                    if (typeof firebase === 'undefined') {
                        if (n > 20) { err(new Error('Firebase non caricato')); return; }
                        setTimeout(go, 500);
                        return;
                    }
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp({
                                apiKey: "AIzaSyCrdoY0gxuzPdSp955NhnQBRkjRIUpdPKI",
                                authDomain: "app-npl-italia.firebaseapp.com",
                                databaseURL: "https://app-npl-italia-default-rtdb.europe-west1.firebasedatabase.app",
                                projectId: "app-npl-italia",
                                storageBucket: "app-npl-italia.firebasestorage.app",
                                messagingSenderId: "299298163787",
                                appId: "1:299298163787:web:4d08b7dd3273aa4dc011ce"
                            });
                        }
                        db = firebase.database();
                        fbOk = true;
                        console.log('✅ FB OK');
                        ok();
                    } catch (e) { err(e); }
                }
                go();
            });
        }

        async function doLogin() {
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value;
            if (usrs[u] && usrs[u].pw === p) {
                shLd('Connessione...');
                try {
                    await initFB();
                    usr = {u, rol: usrs[u].rol, lvl: usrs[u].lvl};
                    
                    // NO AUTO-LOGIN - commenta la riga sotto se vuoi auto-login
                    // localStorage.setItem('usr', JSON.stringify(usr));
                    
                    document.getElementById('loginScr').classList.add('hide');
                    document.getElementById('app').classList.remove('hide');
                    document.getElementById('badge').textContent = `${usr.rol}: ${u}`;
                    if (usr.lvl === 3) {
                        document.getElementById('btnUp').classList.remove('hide');
                        document.getElementById('btnDel').classList.remove('hide');
                    }
                    await ldData();
                } catch (e) {
                    alert('Errore: ' + e.message);
                } finally {
                    hdLd();
                }
            } else {
                document.getElementById('loginAlert').innerHTML = '<div style="background:#f8d7da;color:#721c24;padding:11px;border-radius:7px;margin-bottom:13px;">❌ Credenziali errate!</div>';
                setTimeout(() => document.getElementById('loginAlert').innerHTML = '', 2500);
            }
        }

        function doLogout() {
            usr = null; allData = [];
            // localStorage.removeItem('usr'); // NON SERVE PIÙ
            document.getElementById('loginScr').classList.remove('hide');
            document.getElementById('app').classList.add('hide');
            document.getElementById('user').value = '';
            document.getElementById('pass').value = '';
        }

        // DISABILITO AUTO-LOGIN
        /*
        window.addEventListener('DOMContentLoaded', async () => {
            const saved = localStorage.getItem('usr');
            if (saved) {
                try {
                    usr = JSON.parse(saved);
                    shLd('Connessione...');
                    await initFB();
                    document.getElementById('loginScr').classList.add('hide');
                    document.getElementById('app').classList.remove('hide');
                    document.getElementById('badge').textContent = `${usr.rol}: ${usr.u}`;
                    if (usr.lvl === 3) {
                        document.getElementById('btnUp').classList.remove('hide');
                        document.getElementById('btnDel').classList.remove('hide');
                    }
                    await ldData();
                    hdLd();
                } catch (e) {
                    localStorage.removeItem('usr');
                    hdLd();
                }
            }
        });
        */

        async function ldData() {
            shLd('Caricamento dati...');
            try {
                const snap = await db.ref('data').once('value');
                const d = snap.val();
                if (!d) {
                    console.log('⚠️ DB vuoto');
                    allData = [];
                    rend();
                    return;
                }
                allData = Array.isArray(d) ? d.filter(x => x) : Object.values(d).filter(x => x);
                console.log(`✅ ${allData.length} record`);
                popFilt();
                rend();
            } catch (e) {
                console.error('❌', e);
                alert('Errore: ' + e.message);
            } finally {
                hdLd();
            }
        }

        function popFilt() {
            const regs = new Set();
            allData.forEach(i => { if (i.Regione) regs.add(i.Regione); });
            document.getElementById('fReg').innerHTML = '<option value="">Tutte le regioni</option>' +
                [...regs].sort().map(r => `<option value="${r}">${r}</option>`).join('');
            updCitta();
        }

        function updCitta() {
            const r = document.getElementById('fReg').value;
            const cits = new Set();
            allData.forEach(d => {
                if (r && d.Regione !== r) return;
                if (d.Comune) cits.add(d.Comune);
            });
            document.getElementById('fCit').innerHTML = '<option value="">Tutte le città</option>' +
                [...cits].sort().map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function appFilt() { rend(); }
        function clrFilt() {
            document.getElementById('fTipo').value = '';
            document.getElementById('fReg').value = '';
            document.getElementById('fCit').value = '';
            document.getElementById('fSearch').value = '';
            rend();
        }

        function getFilt() {
            let f = [...allData];
            const t = document.getElementById('fTipo').value;
            if (t) f = f.filter(d => d.Tipo === t);
            
            const r = document.getElementById('fReg').value;
            if (r) f = f.filter(d => d.Regione === r);
            
            const c = document.getElementById('fCit').value;
            if (c) f = f.filter(d => d.Comune === c);
            
            const s = document.getElementById('fSearch').value.toLowerCase();
            if (s) f = f.filter(d => Object.values(d).some(v => String(v).toLowerCase().includes(s)));
            
            return f;
        }

        function prsDate(s) {
            if (!s) return new Date(9999, 11, 31);
            const p = String(s).split('/');
            if (p.length === 3) {
                const dt = new Date(p[2], p[1] - 1, p[0]);
                return isNaN(dt) ? new Date(9999, 11, 31) : dt;
            }
            return new Date(9999, 11, 31);
        }

        function prsPrz(v) {
            if (!v) return null;
            if (typeof v === 'number') return v;
            // Formato italiano: € 67.500,00
            const s = String(v).replace('€', '').replace(/\s/g, '').trim();
            const n = s.replace(/\./g, '').replace(',', '.');
            const f = parseFloat(n);
            return isNaN(f) ? null : f;
        }

        function rend() {
            let d = getFilt();
            
            // Ordina DECRESCENTE per data (PIÙ LONTANE PRIMA)
            d = [...d].sort((a, b) => {
                const dA = prsDate(a['Data Asta']);
                const dB = prsDate(b['Data Asta']);
                return dB - dA; // DECRESCENTE
            });

            const asteN = allData.filter(x => x.Tipo === 'Asta').length;
            const nplN = allData.filter(x => x.Tipo === 'NPL').length;
            document.getElementById('sAste').textContent = asteN;
            document.getElementById('sNPL').textContent = nplN;

            const tbody = document.getElementById('tblBody');
            const thead = document.getElementById('tblHead');
            
            if (d.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:35px;">Nessun risultato</td></tr>';
                document.getElementById('blurWrap').classList.add('hide');
                return;
            }

            // Determina se mostrare ASTE o NPL
            const tipoFiltro = document.getElementById('fTipo').value;
            const isNPL = tipoFiltro === 'NPL' || (!tipoFiltro && d.length > 0 && d[0].Tipo === 'NPL');
            
            // Aggiorna titolo e header
            if (isNPL) {
                document.getElementById('tblTitle').innerHTML = '📋 NPL Disponibili';
                thead.innerHTML = '<tr><th>Project ID</th><th>Numero Pratica</th><th>Indirizzo</th><th>Regione</th><th>Comune</th><th>Debitoria Totale</th><th>Azioni</th></tr>';
            } else {
                document.getElementById('tblTitle').innerHTML = '🔨 Aste Disponibili';
                thead.innerHTML = '<tr><th>Tipo</th><th>Regione</th><th>Comune</th><th>Indirizzo</th><th>Prezzo Base Asta</th><th>Data Asta</th><th>Azioni</th></tr>';
            }

            window.tblData = d;

            if (isNPL) {
                // TABELLA NPL
                tbody.innerHTML = d.map((it, i) => {
                    const projID = it['Project ID'] || '-';
                    const numPrat = it['Numero Pratica _ NDG'] || '-';
                    const ind = it['Indirizzo'] || '-';
                    const reg = it.Regione || '-';
                    const com = it.Comune || '-';
                    
                    let deb = '-';
                    const debVal = it['Debitoria totale'];
                    const debP = prsPrz(debVal);
                    if (debP) deb = '€' + Math.round(debP).toLocaleString('it-IT');

                    return `<tr>
                        <td>${projID}</td>
                        <td>${numPrat}</td>
                        <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${ind}">${ind}</td>
                        <td>${reg}</td>
                        <td>${com}</td>
                        <td><strong style="color:#2196F3;">${deb}</strong></td>
                        <td><button class="btn-det" onclick="shDet(${i})">Dettagli</button></td>
                    </tr>`;
                }).join('');
            } else {
                // TABELLA ASTE
                tbody.innerHTML = d.map((it, i) => {
                    const bdg = '<span class="badge badge-asta">🔨 ASTA</span>';
                    const reg = it.Regione || '-';
                    const com = it.Comune || '-';
                    const ind = it.Indirizzo || '-';
                    
                    let prz = '-';
                    const pV = it["Prezzo base d'asta"];
                    const pP = prsPrz(pV);
                    if (pP) prz = '€' + Math.round(pP).toLocaleString('it-IT');
                    
                    const dta = it['Data Asta'] || '-';

                    return `<tr>
                        <td>${bdg}</td>
                        <td>${reg}</td>
                        <td>${com}</td>
                        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${ind}">${ind}</td>
                        <td><strong style="color:#4CAF50;">${prz}</strong></td>
                        <td>${dta}</td>
                        <td><button class="btn-det" onclick="shDet(${i})">Dettagli</button></td>
                    </tr>`;
                }).join('');
            }

            document.getElementById('recordCount').textContent = d.length;
        }

        function shDet(idx) {
            const it = window.tblData[idx];
            const cont = document.getElementById('detCont');
            
            // Ordine campi per ASTE
            const ordineAste = [
                'Project ID',
                'Tipo',
                'Titolo',
                'Indirizzo',
                'Comune',
                'Provincia',
                'CAP',
                'Regione',
                'Destinazione d\'uso',
                'Prezzo base d\'asta',
                'Situazione debitoria',
                'Valutazione garanzie',
                'Tribunale',
                'RG',
                'Data Asta',
                'Lotto',
                'Numero Pratica _ NDG',
                'vuoi prenderlo in pre asta?Clicca e scrivici'
            ];
            
            // Ordine campi per NPL
            const ordineNPL = [
                'Project ID',
                'Tipo',
                'Numero Pratica _ NDG',
                'New',
                'Titolo',
                'Indirizzo',
                'CAP',
                'Comune',
                'Provincia',
                'Regione',
                'Destinazione d\'uso',
                'Debitoria totale',
                'Situazione debitoria',
                'Data saldo originale dei prestiti',
                'Numero immobili',
                'Area totale di tutte le proprietà (in mq)',
                'Valutazione garanzie secondo ultimi report',
                'Prezzo base d\'asta',
                'Telefonare per info'
            ];
            
            const ordine = it.Tipo === 'Asta' ? ordineAste : ordineNPL;
            const keys = [...ordine.filter(k => it.hasOwnProperty(k)), ...Object.keys(it).filter(k => !ordine.includes(k))];
            
            cont.innerHTML = keys.map(k => {
                let v = it[k];
                
                // Formatta i prezzi
                if ((k.includes('Prezzo') || k.includes('Debitoria') || k.includes('Valutazione') || k.includes('debitoria')) && v) {
                    const num = prsPrz(v);
                    if (num) v = '€' + Math.round(num).toLocaleString('it-IT');
                }
                
                // Formatta link
                if ((k.includes('vuoi prenderlo') || k.includes('Clicca')) && v && v.includes('http')) {
                    v = `<a href="${v}" target="_blank" style="color:#667eea;font-weight:600;">📧 Contattaci per Pre-Asta</a>`;
                }
                
                // Formatta telefono
                if (k.includes('Telefon') && v) {
                    v = `<a href="tel:${v}" style="color:#4CAF50;font-weight:600;">📞 ${v}</a>`;
                }
                
                if (!v || v === '' || v === 'null' || v === 'undefined') v = '-';
                
                return `<div class="det-item"><label>${k}</label><div class="val">${v}</div></div>`;
            }).join('');
            
            document.getElementById('modal').classList.add('show');
        }

        function clsMod() { document.getElementById('modal').classList.remove('show'); }
        function toggleAdmin() { document.getElementById('adminPan').classList.toggle('hide'); }

        async function upFile(e) {
            const f = e.target.files[0];
            if (!f) return;
            shLd('Lettura Excel...');
            try {
                const d = await rdXl(f);
                const fn = f.name.toUpperCase();
                const tp = fn.includes('ASTE') ? 'Asta' : 'NPL';
                d.forEach(r => r.Tipo = tp);
                shLd('Salvataggio...');
                await saveFB(d);
                document.getElementById('upAlert').innerHTML = '<div style="background:#d4edda;color:#155724;padding:11px;border-radius:7px;margin-bottom:13px;">✅ Caricati ' + d.length + ' record!</div>';
                setTimeout(() => document.getElementById('upAlert').innerHTML = '', 2500);
            } catch (err) {
                document.getElementById('upAlert').innerHTML = '<div style="background:#f8d7da;color:#721c24;padding:11px;border-radius:7px;margin-bottom:13px;">❌ ' + err.message + '</div>';
            } finally {
                hdLd();
                e.target.value = '';
            }
        }

        function rdXl(f) {
            return new Promise((ok, err) => {
                const rdr = new FileReader();
                rdr.onload = (e) => {
                    try {
                        const dt = new Uint8Array(e.target.result);
                        const wb = XLSX.read(dt, {type: 'array'});
                        const sh = wb.Sheets[wb.SheetNames[0]];
                        const js = XLSX.utils.sheet_to_json(sh, {defval: ''});
                        ok(js);
                    } catch (er) {
                        err(new Error('File non valido'));
                    }
                };
                rdr.onerror = () => err(new Error('Errore lettura'));
                rdr.readAsArrayBuffer(f);
            });
        }

        async function saveFB(newD) {
            const snap = await db.ref('data').once('value');
            const ex = snap.val();
            let all = ex ? Object.values(ex).filter(x => x) : [];
            all = [...all, ...newD];
            const upd = {};
            all.forEach((it, i) => { upd[i] = it; });
            await db.ref('data').set(upd);
            allData = all;
            popFilt();
            rend();
        }

        async function delDB() {
            if (!confirm('⚠️ Cancellare TUTTI i dati?')) return;
            shLd('Cancellazione...');
            try {
                await db.ref('data').remove();
                allData = [];
                document.getElementById('sAste').textContent = '0';
                document.getElementById('sNPL').textContent = '0';
                document.getElementById('tblBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:35px;">Database vuoto - Carica dati</td></tr>';
                document.getElementById('blurWrap').classList.add('hide');
                document.getElementById('fReg').innerHTML = '<option value="">Tutte le regioni</option>';
                document.getElementById('fCit').innerHTML = '<option value="">Tutte le città</option>';
                hdLd();
                alert('✅ Database svuotato!');
            } catch (e) {
                hdLd();
                alert('❌ Errore: ' + e.message);
            }
        }

        document.getElementById('modal').addEventListener('click', e => { if (e.target.id === 'modal') clsMod(); });
        document.getElementById('pass').addEventListener('keypress', e => { if (e.key === 'Enter') doLogin(); });
    </script>
</body>
</html>
