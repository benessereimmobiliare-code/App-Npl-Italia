<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceleratore Immobiliare</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; overflow-x: hidden; }
        html { overflow-x: hidden; }
        
        /* TOP NAV */
        .top-bar { background: white; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-wrap: wrap; gap: 15px; }
        .logo { color: #667eea; font-weight: 700; font-size: 16px; }
        .area-btn { padding: 8px 16px; border: 2px solid #ddd; border-radius: 10px; font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; line-height: 1.3; background: white; transition: all 0.3s; }
        .area-btn small { font-size: 9px; font-weight: 500; display: block; margin-top: 2px; }
        .area-free { background: #4CAF50; color: white; border-color: #4CAF50; }
        .area-lock { opacity: 0.6; }
        .area-lock:hover { opacity: 1; transform: scale(1.05); }
        .top-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .top-btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-grn { background: #4CAF50; color: white; }
        .btn-org { background: #FF9800; color: white; }
        .btn-red { background: #f44336; color: white; }
        
        /* TOAST INVESTITORI */
        .toast-inv { position: fixed; bottom: 20px; right: 20px; background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); padding: 18px 22px; min-width: 320px; max-width: 400px; z-index: 888; opacity: 0; transform: translateX(450px); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .toast-inv.show { opacity: 1; transform: translateX(0); }
        .toast-inv.hide-anim { opacity: 0; transform: translateX(450px); }
        .toast-close { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 20px; cursor: pointer; color: #999; line-height: 1; padding: 0; width: 24px; height: 24px; }
        .toast-close:hover { color: #f44336; }
        .toast-head { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .toast-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; flex-shrink: 0; }
        .toast-info { flex: 1; }
        .toast-nome { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 3px; }
        .toast-prof { font-size: 12px; color: #666; }
        .toast-det { margin-bottom: 12px; }
        .toast-det div { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px; color: #555; }
        .toast-det svg { width: 16px; height: 16px; flex-shrink: 0; }
        .toast-budget { font-size: 20px; font-weight: 700; color: #4CAF50; }
        .toast-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; transition: transform 0.2s; }
        .toast-btn:hover { transform: scale(1.03); }
        
        @media (max-width: 768px) {
            .toast-inv { bottom: 10px; right: 10px; left: 10px; min-width: auto; max-width: none; }
        }
        
        /* HEADER STATS */
        .hero { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 50px 30px; text-align: center; }
        .hero h1 { font-size: 2.2em; margin-bottom: 8px; }
        .hero p { opacity: 0.95; margin-bottom: 35px; }
        .stats { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
        .stat { background: rgba(255,255,255,0.15); padding: 18px 25px; border-radius: 10px; min-width: 130px; }
        .stat-num { font-size: 28px; font-weight: 700; }
        .stat-lbl { font-size: 12px; opacity: 0.9; margin-top: 4px; }
        
        /* AFFARI PRONTI */
        .affari { background: #1a1f3a; color: white; padding: 45px 30px; }
        .affari-wrap { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr 280px; gap: 35px; align-items: center; }
        .affari h2 { font-size: 1.9em; margin-bottom: 18px; }
        .affari p { line-height: 1.6; margin-bottom: 12px; }
        .affari ul { list-style: none; margin: 18px 0; }
        .affari li { padding: 6px 0 6px 22px; position: relative; }
        .affari li:before { content: '‚úì'; position: absolute; left: 0; color: #4CAF50; font-weight: 700; }
        .btn-big { background: #FFC107; color: #000; padding: 14px 28px; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; }
        .box-gold { background: rgba(255,255,255,0.1); padding: 18px; border-radius: 10px; text-align: center; }
        
        /* FILTRI */
        .filtri { background: white; padding: 28px 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filtri h3 { color: #667eea; margin-bottom: 18px; font-size: 1.4em; }
        .filtri-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .filtri-grid select, .filtri-grid input { padding: 11px; border: 2px solid #ddd; border-radius: 7px; width: 100%; }
        .btn-filtri { display: flex; gap: 8px; }
        
        /* CORSI */
        .corsi { padding: 45px 30px; background: #fafafa; }
        .corsi h3 { text-align: center; font-size: 1.7em; margin-bottom: 35px; color: #333; }
        .corsi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; max-width: 1100px; margin: 0 auto; }
        .card { background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .card-ico { padding: 35px; text-align: center; font-size: 55px; }
        .card-txt { background: white; padding: 22px; }
        .card-txt h4 { font-size: 1.2em; margin-bottom: 8px; color: #333; }
        .card-txt p { color: #666; margin-bottom: 12px; line-height: 1.4; }
        .btn-gratis { background: #4CAF50; color: white; padding: 9px 18px; border: none; border-radius: 7px; font-weight: 700; cursor: pointer; }
        
        /* TABELLA */
        .tbl-sec { padding: 35px 30px; background: white; }
        .tbl-sec h3 { font-size: 1.7em; margin-bottom: 25px; color: #333; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1000px; }
        thead { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        th { padding: 12px 10px; text-align: left; font-weight: 600; white-space: nowrap; font-size: 11px; }
        td { padding: 10px; border-bottom: 1px solid #e5e5e5; font-size: 12px; }
        tr:hover { background: #f9f9f9; }
        .badge { padding: 5px 10px; border-radius: 5px; font-weight: 700; font-size: 11px; color: white; display: inline-block; }
        .badge-asta { background: #FF9800; }
        .badge-npl { background: #2196F3; }
        .btn-det { background: #FFC107; color: #000; padding: 7px 14px; border: none; border-radius: 7px; font-weight: 700; cursor: pointer; font-size: 11px; white-space: nowrap; }
        
        /* BLUR */
        .blur-wrap { position: relative; margin-top: 18px; }
        .blur-tbl { filter: blur(4px); opacity: 0.25; }
        .blur-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.97); padding: 35px; border-radius: 12px; text-align: center; box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
        .blur-over h3 { color: #667eea; font-size: 1.6em; margin-bottom: 12px; }
        .btn-prem { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 13px 30px; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; }
        
        /* LOGIN */
        .login-scr { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea, #764ba2); }
        .login-box { background: white; padding: 38px; border-radius: 18px; box-shadow: 0 18px 55px rgba(0,0,0,0.3); max-width: 380px; width: 100%; }
        .login-box h1 { color: #667eea; margin-bottom: 28px; text-align: center; }
        .inp-grp { margin-bottom: 18px; }
        .inp-grp input { width: 100%; padding: 11px; border: 2px solid #ddd; border-radius: 7px; font-size: 15px; }
        .btn-log { width: 100%; padding: 13px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
        
        /* ADMIN */
        .admin { background: #fff; padding: 28px 30px; margin: 0 30px 18px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); z-index: 999; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal.show { display: flex; }
        .modal-box { background: white; padding: 28px; border-radius: 12px; max-width: 850px; width: 100%; max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid #e5e5e5; position: sticky; top: 0; background: white; z-index: 1; }
        .det-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
        .det-item { padding: 11px; background: #f9f9f9; border-radius: 7px; word-break: break-word; }
        .det-item label { display: block; font-size: 10px; color: #666; margin-bottom: 4px; text-transform: uppercase; font-weight: 600; }
        .det-item .val { font-size: 13px; color: #333; font-weight: 500; }
        
        .hide { display: none !important; }
        .load { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .load.show { display: flex; }
        .spin { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 45px; height: 45px; animation: sp 1s linear infinite; }
        @keyframes sp { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* RESPONSIVE MOBILE */
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .top-bar { padding: 10px 10px; flex-direction: column; align-items: flex-start; }
            .logo { margin-bottom: 10px; font-size: 14px; }
            .area-btn { padding: 8px 10px; font-size: 9px; min-height: 44px; /* touch area */ }
            .area-btn small { font-size: 7px; }
            .top-btns { width: 100%; justify-content: space-between; flex-wrap: wrap; gap: 5px; }
            .top-btn { padding: 8px 12px; font-size: 10px; min-height: 40px; /* touch area */ }
            #badge { font-size: 10px; padding: 6px 10px; }
            
            .hero { padding: 25px 10px; }
            .hero h1 { font-size: 1.4em; }
            .hero p { font-size: 13px; }
            .stats { gap: 12px; padding: 0 10px; }
            .stat { padding: 12px 15px; min-width: 90px; }
            .stat-num { font-size: 20px; }
            .stat-lbl { font-size: 9px; }
            
            .affari { padding: 25px 10px; }
            .affari-wrap { grid-template-columns: 1fr; gap: 20px; }
            .affari h2 { font-size: 1.3em; }
            .affari p { font-size: 13px; }
            .btn-big { padding: 12px 20px; font-size: 13px; min-height: 44px; /* touch area */ }
            
            .corsi { padding: 25px 10px; }
            .corsi h3 { font-size: 1.2em; }
            .corsi-grid { grid-template-columns: 1fr; gap: 15px; }
            .btn-gratis { padding: 10px 18px; min-height: 44px; /* touch area */ }
            
            .filtri { padding: 18px 10px; }
            .filtri h3 { font-size: 1.1em; }
            .filtri-grid { grid-template-columns: 1fr; gap: 10px; }
            .filtri-grid select, .filtri-grid input { min-height: 44px; font-size: 16px; /* iOS zoom fix */ }
            
            .tbl-sec { padding: 18px 8px; }
            .tbl-sec h3 { font-size: 1.2em; margin-bottom: 10px; }
            table { font-size: 10px; min-width: 700px; }
            th { padding: 8px 5px; font-size: 9px; }
            td { padding: 8px 5px; font-size: 10px; }
            .btn-det { padding: 6px 10px; font-size: 10px; min-height: 36px; /* touch area */ }
            
            .modal { padding: 10px; }
            .modal-box { padding: 15px; margin: 5px; max-height: 85vh; }
            .modal-head h2 { font-size: 1.1em; }
            .det-grid { grid-template-columns: 1fr; gap: 8px; }
            .det-item { padding: 10px; }
            .btn-red { min-height: 44px; /* touch area */ }
            
            .admin { padding: 15px 10px; margin: 0 10px 10px; }
            #fileInp { min-height: 44px; /* touch area */ }
            
            .login-box { padding: 20px; margin: 10px; }
            .login-box h1 { font-size: 1.2em; }
            .inp-grp input { min-height: 44px; font-size: 16px; /* iOS zoom fix */ }
            .btn-log { min-height: 44px; /* touch area */ }
        }
        
        @media (max-width: 480px) {
            .hero h1 { font-size: 1.1em; }
            .stats { flex-direction: column; gap: 10px; }
            .stat { width: 100%; max-width: 100%; }
            .area-btn { font-size: 8px; padding: 6px 8px; }
            table { font-size: 9px; min-width: 600px; }
            th, td { padding: 6px 4px; }
        }
    </style>
</head>
<body>
    <div id="load" class="load"><div style="background:white;padding:35px;border-radius:12px;text-align:center;"><div class="spin"></div><p id="loadTxt" style="margin-top:18px;font-weight:600;">Caricamento...</p></div></div>
    
    <div id="toastInv" class="toast-inv"></div>

    <div id="loginScr" class="login-scr">
        <div class="login-box">
            <h1>üöÄ Acceleratore Immobiliare</h1>
            <div id="loginAlert"></div>
            <div class="inp-grp"><input type="text" id="user" placeholder="Username"></div>
            <div class="inp-grp"><input type="password" id="pass" placeholder="Password"></div>
            <button class="btn-log" onclick="doLogin()">Accedi</button>
        </div>
    </div>

    <div id="app" class="hide">
        <div class="top-bar">
            <div class="logo">üöÄ Acceleratore Immobiliare</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button class="area-btn area-free">‚úì<br>Area FREE<br><small>Attivo</small></button>
                <button class="area-btn area-lock">üîí<br>Area Premium<br><small>UPGRADE</small></button>
                <button class="area-btn area-lock">üîí<br>Progetto 100 Soci<br><small>VIP</small></button>
                <button class="area-btn area-lock">üí∞<br>Area Esperti<br><small>PRO</small></button>
            </div>
            <div class="top-btns">
                <span id="badge" style="padding:8px 16px;background:#f0f0f0;border-radius:18px;font-weight:600;font-size:12px;"></span>
                <button class="top-btn btn-grn hide" id="btnUp" onclick="toggleAdmin()">Carica File</button>
                <button class="top-btn btn-org hide" id="btnDel" onclick="delDB()">Svuota DB</button>
                <button class="top-btn btn-red" onclick="doLogout()">Esci</button>
            </div>
        </div>

        <div id="adminPan" class="admin hide">
            <h3 style="color:#667eea;margin-bottom:12px;">üìä Upload Unico - Aste / NPL / Investitori</h3>
            <div id="upAlert"></div>
            <div style="background:#f0f8ff;padding:15px;border-radius:8px;margin-bottom:15px;">
                <p style="margin-bottom:10px;font-size:14px;font-weight:600;">üìÅ Carica qualsiasi file Excel:</p>
                <ul style="margin-left:20px;margin-bottom:12px;font-size:13px;color:#666;">
                    <li><strong>ASTE</strong> ‚Üí File con nome che contiene "ASTE" o "aste"</li>
                    <li><strong>NPL</strong> ‚Üí File con nome che contiene "NPL" o "npl"</li>
                    <li><strong>INVESTITORI</strong> ‚Üí File con colonne: Nome, Cognome, Email, Cellulare, Budget, Professione</li>
                </ul>
                <input type="file" id="fileInp" accept=".xlsx,.xls" onchange="upFile(event)">
                <p style="margin-top:10px;color:#666;font-size:12px;">üí° L'app riconosce automaticamente il tipo di file!</p>
            </div>
            
            <div style="background:#e8f5e9;padding:15px;border-radius:8px;">
                <h4 style="margin-bottom:10px;color:#2e7d32;">üöÄ Caricamento Rapido (Solo Test)</h4>
                <button onclick="caricaDatiEsempio()" class="top-btn btn-grn" style="margin-right:10px;">üì• Carica 15 Investitori Esempio</button>
                <p style="font-size:12px;color:#666;margin-top:8px;">Carica automaticamente 15 investitori con ‚Ç¨4.26M totale</p>
            </div>
        </div>

        <div id="investitoriPan" class="admin hide">
            <h3 style="color:#667eea;margin-bottom:12px;">üíº Gestione Investitori</h3>
            <div id="invAlert"></div>
            <p style="margin-bottom:15px;color:#666;font-size:13px;">Capitale Totale: <strong style="color:#4CAF50;font-size:18px;">‚Ç¨<span id="capitaleTot">0</span></strong></p>
            
            <div style="margin-bottom:20px;padding:15px;background:#e8f5e9;border-radius:8px;">
                <h4 style="margin-bottom:10px;">üöÄ Dati Iniziali (Solo Prima Volta)</h4>
                <button onclick="caricaDatiEsempio()" class="top-btn btn-grn">üì• Carica 15 Investitori Esempio</button>
                <p style="font-size:12px;color:#666;margin-top:8px;">Carica automaticamente 15 investitori con ‚Ç¨4.26M totale</p>
            </div>
            
            <div style="margin-bottom:20px;padding:15px;background:#f0f8ff;border-radius:8px;">
                <h4 style="margin-bottom:10px;">üìÅ Carica Excel Investitori</h4>
                <input type="file" id="fileInvInp" accept=".xlsx,.xls" onchange="upFileInv(event)" style="margin-bottom:10px;">
                <p style="font-size:12px;color:#666;">Carica file Excel con colonne: Nome, Cognome, Email, Cellulare, Budget, Professione</p>
            </div>
            
            <div style="margin-bottom:20px;">
                <h4 style="margin-bottom:10px;">‚ûï Aggiungi Investitore Manualmente</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:10px;">
                    <input type="text" id="invNome" placeholder="Nome">
                    <input type="text" id="invCognome" placeholder="Cognome">
                    <input type="email" id="invEmail" placeholder="Email">
                    <input type="tel" id="invCell" placeholder="Cellulare">
                    <input type="number" id="invBudget" placeholder="Budget ‚Ç¨">
                    <input type="text" id="invProf" placeholder="Professione">
                </div>
                <button onclick="aggiungiInvestitore()" class="top-btn btn-grn">‚ûï Aggiungi</button>
            </div>

            <div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                    <thead style="background:#f5f5f5;">
                        <tr>
                            <th style="padding:10px;text-align:left;">Nome</th>
                            <th style="padding:10px;text-align:left;">Cognome</th>
                            <th style="padding:10px;text-align:left;">Email</th>
                            <th style="padding:10px;text-align:left;">Cell</th>
                            <th style="padding:10px;text-align:left;">Budget</th>
                            <th style="padding:10px;text-align:left;">Professione</th>
                            <th style="padding:10px;text-align:left;">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="invTableBody">
                        <tr><td colspan="7" style="text-align:center;padding:20px;">Caricamento...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="hero">
            <h1>üè† Acceleratore Immobiliare</h1>
            <p>Accelera i tuoi risultati in Aste e NPL ‚Äì Da zero a PRO</p>
            <div class="stats">
                <div class="stat"><div class="stat-num" id="sAste">0</div><div class="stat-lbl">üìä Aste Attive</div></div>
                <div class="stat"><div class="stat-num" id="sNPL">0</div><div class="stat-lbl">üìã NPL Disponibili</div></div>
                <div class="stat"><div class="stat-num">247</div><div class="stat-lbl">‚≠ê Utenti Premium</div></div>
                <div class="stat"><div class="stat-num">38</div><div class="stat-lbl">üíº Esperti Attivi</div></div>
                <div class="stat">
                    <div class="stat-num" id="statCapitale">‚Ç¨0</div>
                    <div class="stat-lbl">üí∞ Capitale Disponibile</div>
                    <div style="font-size:10px;color:#ccc;margin-top:4px;">per investitori esperti</div>
                </div>
            </div>
        </div>

        <div class="affari">
            <div class="affari-wrap">
                <div>
                    <h2>üíº Affari Pronti</h2>
                    <p><strong>Sei un investitore super impegnato</strong> dalla mattina alla sera ma vuoi sfruttare la capacit√† degli iscritti all'<strong>Area Esperti</strong> del nostro Acceleratore?</p>
                    <p>Usufruirai a <strong>costo zero</strong> del "<strong>Servizio Selezione Esperti Investitori Immobiliari</strong>" con:</p>
                    <ul>
                        <li>Analisi accurata del titolare esperto</li>
                        <li>Rating verificato</li>
                        <li>Analisi regole di ingaggio</li>
                        <li>Messa in contatto diretto investitore-esperto</li>
                    </ul>
                    <button class="btn-big">üìù COMPILA IL QUESTIONARIO</button>
                    <p style="margin-top:12px;font-size:12px;opacity:0.85;">‚ÑπÔ∏è <strong>IMPORTANTE:</strong> Questo NON √® un servizio di investimento, ma esclusivamente un servizio di messa in contatto diretto tra investitori ed esperti del settore immobiliare.</p>
                </div>
                <div class="box-gold">
                    <div style="font-size:55px;margin-bottom:8px;">ü§ù</div>
                    <div><strong>Investitori ü§ù Esperti</strong></div>
                    <div style="font-size:12px;margin-top:8px;opacity:0.9;">Servizio gratuito di matching</div>
                </div>
            </div>
        </div>

        <div class="corsi">
            <h3>üìö Corsi Gratuiti per Iniziare</h3>
            <div class="corsi-grid">
                <div class="card">
                    <div class="card-ico">üéì</div>
                    <div class="card-txt">
                        <h4>Come Funzionano le Aste Immobiliari</h4>
                        <p>Impara le basi delle aste giudiziarie.</p>
                        <button class="btn-gratis">GRATIS</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-ico">üí∞</div>
                    <div class="card-txt">
                        <h4>Valutare un NPL in 10 Minuti</h4>
                        <p>Metodo rapido per capire se un credito √® opportunit√† o trappola.</p>
                        <button class="btn-gratis">GRATIS</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-ico">üìù</div>
                    <div class="card-txt">
                        <h4>5 Errori da Evitare</h4>
                        <p>Gli sbagli pi√π comuni dei principianti.</p>
                        <button class="btn-gratis">GRATIS</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="filtri">
            <h3>üîç Filtri di Ricerca</h3>
            <div class="filtri-grid">
                <select id="fTipo"><option value="">Tutti</option><option value="Asta">Aste</option><option value="NPL">NPL</option></select>
                <select id="fReg" onchange="updCitta()"><option value="">Tutte le regioni</option></select>
                <select id="fCit"><option value="">Tutte le citt√†</option></select>
                <input type="text" id="fSearch" placeholder="Cerca...">
            </div>
            <div class="btn-filtri">
                <button class="top-btn btn-grn" onclick="appFilt()">‚úÖ Applica Filtri</button>
                <button class="top-btn btn-red" onclick="clrFilt()">üóëÔ∏è Azzera Filtri</button>
            </div>
        </div>

        <div class="tbl-sec">
            <h3 id="tblTitle">üî® Aste Disponibili</h3>
            <p style="margin-bottom:15px;color:#666;font-size:14px;">Totale: <strong id="recordCount">0</strong> risultati</p>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05);">
                <table id="mainTable">
                    <thead id="tblHead">
                        <tr><th>Tipo</th><th>Regione</th><th>Comune</th><th>Indirizzo</th><th>Prezzo Base Asta</th><th>Data Asta</th><th>Azioni</th></tr>
                    </thead>
                    <tbody id="tblBody"><tr><td colspan="7" style="text-align:center;padding:35px;">Carica dati...</td></tr></tbody>
                </table>
            </div>
            <p style="font-size:11px;color:#666;margin-top:8px;text-align:center;">üì± Scorri orizzontalmente per vedere tutte le colonne</p>
            
            <div id="blurWrap" class="blur-wrap hide">
                <table class="blur-tbl">
                    <tbody id="blurRows">
                        <tr><td>‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà</td></tr>
                        <tr><td>‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà</td></tr>
                        <tr><td>‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà</td></tr>
                    </tbody>
                </table>
                <div class="blur-over">
                    <h3 id="blurTit">üî• Altri Risultati Bloccati</h3>
                    <p>Sblocca tutto con Premium</p>
                    <button class="btn-prem">Passa a Premium</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h2>Dettaglio</h2>
                <button class="btn-red" onclick="clsMod()" style="padding:7px 14px;border:none;border-radius:7px;font-weight:600;cursor:pointer;">Chiudi</button>
            </div>
            <div id="detCont" class="det-grid"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        let db, allData = [], usr = null, fbOk = false;
        let investitori = [];
        let capitaleDisponibile = 0; // parte da 0
        const usrs = {'admin': {pw: 'admin2025', rol: 'Admin', lvl: 3}};
        
        // Inizializza counter visivo a ‚Ç¨0
        window.addEventListener('DOMContentLoaded', () => {
            const statEl = document.getElementById('statCapitale');
            if (statEl) statEl.textContent = '‚Ç¨0';
        });

        function shLd(t = 'Caricamento...') { document.getElementById('loadTxt').textContent = t; document.getElementById('load').classList.add('show'); }
        function hdLd() { document.getElementById('load').classList.remove('show'); }

        async function initFB() {
            if (fbOk) return;
            return new Promise((ok, err) => {
                let n = 0;
                function go() {
                    n++;
                    if (typeof firebase === 'undefined') {
                        if (n > 20) { err(new Error('Firebase non caricato')); return; }
                        setTimeout(go, 500);
                        return;
                    }
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp({
                                apiKey: "AIzaSyCrdoY0gxuzPdSp955NhnQBRkjRIUpdPKI",
                                authDomain: "app-npl-italia.firebaseapp.com",
                                databaseURL: "https://app-npl-italia-default-rtdb.europe-west1.firebasedatabase.app",
                                projectId: "app-npl-italia",
                                storageBucket: "app-npl-italia.firebasestorage.app",
                                messagingSenderId: "299298163787",
                                appId: "1:299298163787:web:4d08b7dd3273aa4dc011ce"
                            });
                        }
                        db = firebase.database();
                        fbOk = true;
                        console.log('‚úÖ FB OK');
                        ok();
                    } catch (e) { err(e); }
                }
                go();
            });
        }

        async function doLogin() {
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value;
            if (usrs[u] && usrs[u].pw === p) {
                shLd('Connessione...');
                try {
                    await initFB();
                    usr = {u, rol: usrs[u].rol, lvl: usrs[u].lvl};
                    
                    // NO AUTO-LOGIN - commenta la riga sotto se vuoi auto-login
                    // localStorage.setItem('usr', JSON.stringify(usr));
                    
                    document.getElementById('loginScr').classList.add('hide');
                    document.getElementById('app').classList.remove('hide');
                    document.getElementById('badge').textContent = `${usr.rol}: ${u}`;
                    if (usr.lvl === 3) {
                        document.getElementById('btnUp').classList.remove('hide');
                        document.getElementById('btnDel').classList.remove('hide');
                    }
                    await ldData();
                } catch (e) {
                    alert('Errore: ' + e.message);
                } finally {
                    hdLd();
                }
            } else {
                document.getElementById('loginAlert').innerHTML = '<div style="background:#f8d7da;color:#721c24;padding:11px;border-radius:7px;margin-bottom:13px;">‚ùå Credenziali errate!</div>';
                setTimeout(() => document.getElementById('loginAlert').innerHTML = '', 2500);
            }
        }

        function doLogout() {
            usr = null; allData = [];
            // localStorage.removeItem('usr'); // NON SERVE PI√ô
            document.getElementById('loginScr').classList.remove('hide');
            document.getElementById('app').classList.add('hide');
            document.getElementById('user').value = '';
            document.getElementById('pass').value = '';
        }

        // DISABILITO AUTO-LOGIN
        /*
        window.addEventListener('DOMContentLoaded', async () => {
            const saved = localStorage.getItem('usr');
            if (saved) {
                try {
                    usr = JSON.parse(saved);
                    shLd('Connessione...');
                    await initFB();
                    document.getElementById('loginScr').classList.add('hide');
                    document.getElementById('app').classList.remove('hide');
                    document.getElementById('badge').textContent = `${usr.rol}: ${usr.u}`;
                    if (usr.lvl === 3) {
                        document.getElementById('btnUp').classList.remove('hide');
                        document.getElementById('btnDel').classList.remove('hide');
                    }
                    await ldData();
                    hdLd();
                } catch (e) {
                    localStorage.removeItem('usr');
                    hdLd();
                }
            }
        });
        */

        async function ldData() {
            shLd('Caricamento dati...');
            try {
                const snap = await db.ref('data').once('value');
                const d = snap.val();
                if (!d) {
                    console.log('‚ö†Ô∏è DB vuoto');
                    allData = [];
                    rend();
                    return;
                }
                allData = Array.isArray(d) ? d.filter(x => x) : Object.values(d).filter(x => x);
                console.log(`‚úÖ ${allData.length} record`);
                
                // CARICA INVESTITORI
                await ldInvestitori();
                
                // AVVIA TOAST INVESTITORI
                if (investitori.length > 0) {
                    startToastInvestitori();
                }
                
                popFilt();
                rend();
            } catch (e) {
                console.error('‚ùå', e);
                alert('Errore: ' + e.message);
            } finally {
                hdLd();
            }
        }

        async function ldInvestitori() {
            try {
                console.log('üì• Caricamento investitori da Firebase...');
                const snap = await db.ref('investitori').once('value');
                const d = snap.val();
                console.log('üì¶ Dati ricevuti:', d);
                
                if (d) {
                    investitori = Array.isArray(d) ? d : Object.values(d);
                    console.log(`‚úÖ ${investitori.length} investitori caricati`);
                    
                    // CALCOLA CAPITALE TOTALE
                    capitaleDisponibile = investitori.reduce((sum, inv) => sum + (inv.budget || 0), 0);
                    console.log(`üí∞ Capitale totale: ‚Ç¨${capitaleDisponibile.toLocaleString('it-IT')}`);
                    
                    // AGGIORNA COUNTER VISIVO
                    aggiornaCounterCapitale();
                } else {
                    console.log('‚ö†Ô∏è Nessun investitore trovato - database vuoto');
                    investitori = [];
                    capitaleDisponibile = 0;
                    aggiornaCounterCapitale();
                }
            } catch (e) {
                console.error('‚ùå Errore caricamento investitori:', e);
            }
        }

        function aggiornaCounterCapitale() {
            // Aggiorna stat in alto usando ID
            const statEl = document.getElementById('statCapitale');
            if (statEl) {
                if (capitaleDisponibile >= 1000000) {
                    const milioni = capitaleDisponibile / 1000000;
                    // Se ha decimali significativi, mostra 2 cifre, altrimenti 1
                    const decimali = (milioni % 1 >= 0.05) ? 2 : 1;
                    statEl.textContent = '‚Ç¨' + milioni.toFixed(decimali) + 'M';
                } else if (capitaleDisponibile >= 1000) {
                    statEl.textContent = '‚Ç¨' + (capitaleDisponibile / 1000).toFixed(0) + 'K';
                } else {
                    statEl.textContent = '‚Ç¨' + capitaleDisponibile.toLocaleString('it-IT');
                }
            }
            
            // Aggiorna anche nel pannello investitori se aperto
            const capTotEl = document.getElementById('capitaleTot');
            if (capTotEl) {
                capTotEl.textContent = capitaleDisponibile.toLocaleString('it-IT');
            }
        }

        // POPUP ESPERTO dopo 2 minuti
        let popupShown = false;
        function showPopupEsperto() {
            if (popupShown) return;
            popupShown = true;
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
            
            const milioni = capitaleDisponibile / 1000000;
            const decimali = (milioni % 1 >= 0.05) ? 2 : 1;
            
            overlay.innerHTML = `
                <div style="background:white;padding:40px;border-radius:20px;max-width:550px;width:100%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <h2 style="color:#667eea;font-size:1.8em;margin-bottom:15px;">üíº Diventa Esperto Investitore Premium</h2>
                    <p style="font-size:1.5em;font-weight:700;color:#4CAF50;margin-bottom:10px;">Budget Disponibile: ‚Ç¨${capitaleDisponibile.toLocaleString('it-IT')}</p>
                    <p style="color:#666;margin-bottom:15px;line-height:1.6;">Gli investitori della nostra rete hanno un capitale totale di <strong>‚Ç¨${milioni.toFixed(decimali)}M</strong> disponibile per investimenti immobiliari.</p>
                    <div style="background:#fff3cd;border-left:4px solid #FFC107;padding:15px;margin-bottom:20px;text-align:left;">
                        <p style="color:#856404;font-weight:600;margin-bottom:8px;">‚ö° ACCESSO PRIORITARIO</p>
                        <p style="color:#856404;font-size:14px;line-height:1.5;margin:0;">Prima diventi <strong>Esperto Premium</strong>, prima accedi ai <strong>dati completi dei nostri investitori</strong> e alle opportunit√† esclusive.</p>
                    </div>
                    <div style="display:flex;gap:15px;flex-wrap:wrap;">
                        <button onclick="candidatiEsperto()" style="flex:1;padding:15px 25px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;min-width:180px;">‚úÖ Sono Esperto e Approfitto</button>
                        <button onclick="chiudiPopup()" style="flex:1;padding:15px 25px;background:#f44336;color:white;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;min-width:180px;">‚ùå Non Sono Esperto</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            window.popupOverlay = overlay;
        }

        function candidatiEsperto() {
            alert('üéâ Ottimo! Ti contatteremo presto per completare la candidatura come Esperto Investitore.');
            chiudiPopup();
        }

        function chiudiPopup() {
            if (window.popupOverlay) {
                window.popupOverlay.remove();
            }
        }

        // Mostra popup dopo 30 secondi (30000 ms)
        setTimeout(() => {
            if (usr) showPopupEsperto();
        }, 30000);

        // TOAST INVESTITORI - Rotazione ogni 60 secondi
        let toastIndex = 0;
        let toastInterval = null;
        let currentToast = null;

        function startToastInvestitori() {
            if (investitori.length === 0) return;
            
            // Primo toast dopo 60 secondi
            setTimeout(() => {
                showToastInvestitore();
                
                // Poi ogni 2 minuti (120000 ms)
                toastInterval = setInterval(() => {
                    showToastInvestitore();
                }, 120000);
            }, 60000);
        }

        function showToastInvestitore() {
            if (investitori.length === 0) return;
            
            // Chiudi toast precedente se esiste
            if (currentToast) {
                closeToast();
                setTimeout(() => showToastContent(), 500);
            } else {
                showToastContent();
            }
        }

        function showToastContent() {
            const inv = investitori[toastIndex];
            toastIndex = (toastIndex + 1) % investitori.length;
            
            const nomeParziale = inv.nome + ' ' + (inv.cognome ? inv.cognome.charAt(0) + '.' : '');
            const cellOscurato = oscuraCellulare(inv.cellulare);
            const budgetFormatted = '‚Ç¨' + (inv.budget || 0).toLocaleString('it-IT');
            const iniziali = inv.nome.charAt(0) + (inv.cognome ? inv.cognome.charAt(0) : '');
            
            const toastEl = document.getElementById('toastInv');
            toastEl.innerHTML = `
                <button class="toast-close" onclick="closeToast()">√ó</button>
                <div class="toast-head">
                    <div class="toast-avatar">${iniziali}</div>
                    <div class="toast-info">
                        <div class="toast-nome">${nomeParziale}</div>
                        <div class="toast-prof">${inv.professione || 'Investitore'}</div>
                    </div>
                </div>
                <div class="toast-det">
                    <div>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                        <span style="color:#999;">${cellOscurato}</span>
                    </div>
                    <div>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="toast-budget">${budgetFormatted}</span>
                    </div>
                    <div style="font-size:12px;color:#4CAF50;font-weight:600;">
                        ‚úÖ Disponibile per investire con esperto
                    </div>
                </div>
                <button class="toast-btn" onclick="chiamaInvestitore('${inv.email}')">üìû Chiamalo - Passa ad Esperto</button>
            `;
            
            setTimeout(() => toastEl.classList.add('show'), 100);
            currentToast = toastEl;
            
            // Auto-chiudi dopo 115 secondi (per far spazio al prossimo ogni 2 min)
            setTimeout(() => {
                if (currentToast) closeToast();
            }, 115000);
        }

        function closeToast() {
            const toastEl = document.getElementById('toastInv');
            toastEl.classList.remove('show');
            toastEl.classList.add('hide-anim');
            setTimeout(() => {
                toastEl.classList.remove('hide-anim');
                toastEl.innerHTML = '';
            }, 500);
            currentToast = null;
        }

        function oscuraCellulare(cell) {
            if (!cell) return '‚óè‚óè‚óè ‚óè‚óè‚óè ‚óè‚óè‚óè‚óè';
            const clean = cell.replace(/[^0-9]/g, '');
            if (clean.length < 4) return '‚óè‚óè‚óè ‚óè‚óè‚óè ‚óè‚óè‚óè‚óè';
            const ultimi4 = clean.slice(-4);
            return '‚óè‚óè‚óè ‚óè‚óè‚óè ‚óè' + ultimi4.slice(-3);
        }

        function chiamaInvestitore(email) {
            alert(`üéâ Ottimo! Contatteremo ${email} per mettervi in contatto.\n\nPasserai all'Area Esperti e potrai accedere a questo investitore.`);
            closeToast();
        }

        function popFilt() {
            const regs = new Set();
            allData.forEach(i => { if (i.Regione) regs.add(i.Regione); });
            document.getElementById('fReg').innerHTML = '<option value="">Tutte le regioni</option>' +
                [...regs].sort().map(r => `<option value="${r}">${r}</option>`).join('');
            updCitta();
        }

        function updCitta() {
            const r = document.getElementById('fReg').value;
            const cits = new Set();
            allData.forEach(d => {
                if (r && d.Regione !== r) return;
                if (d.Comune) cits.add(d.Comune);
            });
            document.getElementById('fCit').innerHTML = '<option value="">Tutte le citt√†</option>' +
                [...cits].sort().map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function appFilt() { rend(); }
        function clrFilt() {
            document.getElementById('fTipo').value = '';
            document.getElementById('fReg').value = '';
            document.getElementById('fCit').value = '';
            document.getElementById('fSearch').value = '';
            rend();
        }

        function getFilt() {
            let f = [...allData];
            const t = document.getElementById('fTipo').value;
            if (t) f = f.filter(d => d.Tipo === t);
            
            const r = document.getElementById('fReg').value;
            if (r) f = f.filter(d => d.Regione === r);
            
            const c = document.getElementById('fCit').value;
            if (c) f = f.filter(d => d.Comune === c);
            
            const s = document.getElementById('fSearch').value.toLowerCase();
            if (s) f = f.filter(d => Object.values(d).some(v => String(v).toLowerCase().includes(s)));
            
            return f;
        }

        function prsDate(s) {
            if (!s) return new Date(9999, 11, 31);
            const p = String(s).split('/');
            if (p.length === 3) {
                const dt = new Date(p[2], p[1] - 1, p[0]);
                return isNaN(dt) ? new Date(9999, 11, 31) : dt;
            }
            return new Date(9999, 11, 31);
        }

        function prsPrz(v) {
            if (!v) return null;
            if (typeof v === 'number') return v;
            // Formato italiano: ‚Ç¨ 67.500,00
            const s = String(v).replace('‚Ç¨', '').replace(/\s/g, '').trim();
            const n = s.replace(/\./g, '').replace(',', '.');
            const f = parseFloat(n);
            return isNaN(f) ? null : f;
        }

        function rend() {
            let d = getFilt();
            
            // Ordina DECRESCENTE per data (PI√ô LONTANE PRIMA)
            d = [...d].sort((a, b) => {
                const dA = prsDate(a['Data Asta']);
                const dB = prsDate(b['Data Asta']);
                return dB - dA; // DECRESCENTE
            });

            const asteN = allData.filter(x => x.Tipo === 'Asta').length;
            const nplN = allData.filter(x => x.Tipo === 'NPL').length;
            document.getElementById('sAste').textContent = asteN;
            document.getElementById('sNPL').textContent = nplN;

            const tbody = document.getElementById('tblBody');
            const thead = document.getElementById('tblHead');
            
            if (d.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:35px;">Nessun risultato</td></tr>';
                document.getElementById('blurWrap').classList.add('hide');
                return;
            }

            // Determina se mostrare ASTE o NPL
            const tipoFiltro = document.getElementById('fTipo').value;
            const isNPL = tipoFiltro === 'NPL' || (!tipoFiltro && d.length > 0 && d[0].Tipo === 'NPL');
            
            // Aggiorna titolo e header
            if (isNPL) {
                document.getElementById('tblTitle').innerHTML = 'üìã NPL Disponibili';
                thead.innerHTML = '<tr><th>Project ID</th><th>Numero Pratica</th><th>Indirizzo</th><th>Regione</th><th>Comune</th><th>Debitoria Totale</th><th>Azioni</th></tr>';
            } else {
                document.getElementById('tblTitle').innerHTML = 'üî® Aste Disponibili';
                thead.innerHTML = '<tr><th>Tipo</th><th>Regione</th><th>Comune</th><th>Indirizzo</th><th>Prezzo Base Asta</th><th>Data Asta</th><th>Azioni</th></tr>';
            }

            window.tblData = d;
            
            // ASTE: tutte libere (no limit)
            // NPL: prime 5 libere, resto bloccato
            const free = isNPL ? d.slice(0, 5) : d;
            const lock = isNPL ? d.slice(5) : [];

            if (isNPL) {
                // TABELLA NPL
                tbody.innerHTML = free.map((it, i) => {
                    const projID = it['Project ID'] || '-';
                    const numPrat = it['Numero Pratica _ NDG'] || '-';
                    const ind = it['Indirizzo'] || '-';
                    const reg = it.Regione || '-';
                    const com = it.Comune || '-';
                    
                    let deb = '-';
                    const debVal = it['Debitoria totale'];
                    const debP = prsPrz(debVal);
                    if (debP) deb = '‚Ç¨' + Math.round(debP).toLocaleString('it-IT');

                    return `<tr>
                        <td>${projID}</td>
                        <td>${numPrat}</td>
                        <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${ind}">${ind}</td>
                        <td>${reg}</td>
                        <td>${com}</td>
                        <td><strong style="color:#2196F3;">${deb}</strong></td>
                        <td><button class="btn-det" onclick="shDet(${i})">Dettagli</button></td>
                    </tr>`;
                }).join('');
            } else {
                // TABELLA ASTE
                tbody.innerHTML = free.map((it, i) => {
                    const bdg = '<span class="badge badge-asta">üî® ASTA</span>';
                    const reg = it.Regione || '-';
                    const com = it.Comune || '-';
                    const ind = it.Indirizzo || '-';
                    
                    let prz = '-';
                    const pV = it["Prezzo base d'asta"];
                    const pP = prsPrz(pV);
                    if (pP) prz = '‚Ç¨' + Math.round(pP).toLocaleString('it-IT');
                    
                    const dta = it['Data Asta'] || '-';

                    return `<tr>
                        <td>${bdg}</td>
                        <td>${reg}</td>
                        <td>${com}</td>
                        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${ind}">${ind}</td>
                        <td><strong style="color:#4CAF50;">${prz}</strong></td>
                        <td>${dta}</td>
                        <td><button class="btn-det" onclick="shDet(${i})">Dettagli</button></td>
                    </tr>`;
                }).join('');
            }

            // MOSTRA BLUR SOLO PER NPL (mai per aste)
            if (lock.length > 0 && isNPL) {
                document.getElementById('blurTit').textContent = `üìã Altri ${lock.length} NPL Bloccati`;
                document.getElementById('blurWrap').classList.remove('hide');
            } else {
                document.getElementById('blurWrap').classList.add('hide');
            }

            document.getElementById('recordCount').textContent = d.length;
        }

        function shDet(idx) {
            const it = window.tblData[idx];
            const cont = document.getElementById('detCont');
            
            // Ordine campi per ASTE
            const ordineAste = [
                'Project ID',
                'Tipo',
                'Titolo',
                'Indirizzo',
                'Comune',
                'Provincia',
                'CAP',
                'Regione',
                'Destinazione d\'uso',
                'Prezzo base d\'asta',
                'Situazione debitoria',
                'Valutazione garanzie',
                'Tribunale',
                'RG',
                'Data Asta',
                'Lotto',
                'Numero Pratica _ NDG',
                'vuoi prenderlo in pre asta?Clicca e scrivici'
            ];
            
            // Ordine campi per NPL
            const ordineNPL = [
                'Project ID',
                'Tipo',
                'Numero Pratica _ NDG',
                'New',
                'Titolo',
                'Indirizzo',
                'CAP',
                'Comune',
                'Provincia',
                'Regione',
                'Destinazione d\'uso',
                'Debitoria totale',
                'Situazione debitoria',
                'Data saldo originale dei prestiti',
                'Numero immobili',
                'Area totale di tutte le propriet√† (in mq)',
                'Valutazione garanzie secondo ultimi report',
                'Prezzo base d\'asta',
                'Telefonare per info'
            ];
            
            const ordine = it.Tipo === 'Asta' ? ordineAste : ordineNPL;
            const keys = [...ordine.filter(k => it.hasOwnProperty(k)), ...Object.keys(it).filter(k => !ordine.includes(k))];
            
            cont.innerHTML = keys.map(k => {
                let v = it[k];
                
                // Formatta i prezzi
                if ((k.includes('Prezzo') || k.includes('Debitoria') || k.includes('Valutazione') || k.includes('debitoria')) && v) {
                    const num = prsPrz(v);
                    if (num) v = '‚Ç¨' + Math.round(num).toLocaleString('it-IT');
                }
                
                // Formatta link
                if ((k.includes('vuoi prenderlo') || k.includes('Clicca')) && v && v.includes('http')) {
                    v = `<a href="${v}" target="_blank" style="color:#667eea;font-weight:600;">üìß Contattaci per Pre-Asta</a>`;
                }
                
                // Formatta telefono
                if (k.includes('Telefon') && v) {
                    v = `<a href="tel:${v}" style="color:#4CAF50;font-weight:600;">üìû ${v}</a>`;
                }
                
                if (!v || v === '' || v === 'null' || v === 'undefined') v = '-';
                
                return `<div class="det-item"><label>${k}</label><div class="val">${v}</div></div>`;
            }).join('');
            
            document.getElementById('modal').classList.add('show');
        }

        function clsMod() { document.getElementById('modal').classList.remove('show'); }
        function toggleAdmin() { document.getElementById('adminPan').classList.toggle('hide'); }
        async function toggleInvestitori() { 
            document.getElementById('investitoriPan').classList.toggle('hide'); 
            if (!document.getElementById('investitoriPan').classList.contains('hide')) {
                // RICARICA investitori da Firebase ogni volta che apri il pannello
                shLd('Caricamento investitori...');
                await ldInvestitori();
                renderInvestitori();
                hdLd();
            }
        }

        function renderInvestitori() {
            const tbody = document.getElementById('invTableBody');
            document.getElementById('capitaleTot').textContent = capitaleDisponibile.toLocaleString('it-IT');
            
            if (investitori.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;">Nessun investitore</td></tr>';
                return;
            }
            
            tbody.innerHTML = investitori.map((inv, idx) => `
                <tr>
                    <td style="padding:10px;">${inv.nome}</td>
                    <td style="padding:10px;">${inv.cognome}</td>
                    <td style="padding:10px;">${inv.email}</td>
                    <td style="padding:10px;">${inv.cellulare}</td>
                    <td style="padding:10px;"><strong style="color:#4CAF50;">‚Ç¨${(inv.budget || 0).toLocaleString('it-IT')}</strong></td>
                    <td style="padding:10px;">${inv.professione}</td>
                    <td style="padding:10px;"><button onclick="rimuoviInvestitore(${idx})" class="top-btn btn-red" style="padding:5px 10px;font-size:11px;">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        async function caricaDatiEsempio() {
            if (!confirm('‚ö†Ô∏è Caricare 15 investitori esempio su Firebase?\n\nQuesta operazione AGGIUNGER√Ä i dati a quelli esistenti.')) return;
            
            shLd('Caricamento dati esempio...');
            try {
                console.log('üöÄ Inizio caricamento dati esempio...');
                console.log('üìä Investitori attuali:', investitori.length);
                
                const datiEsempio = [
                    {nome: "Marco", cognome: "Rossi", email: "marco.rossi@email.it", cellulare: "+39 333 1234567", budget: 250000, professione: "Imprenditore"},
                    {nome: "Giulia", cognome: "Bianchi", email: "giulia.bianchi@email.it", cellulare: "+39 340 7654321", budget: 180000, professione: "Manager"},
                    {nome: "Luca", cognome: "Verdi", email: "luca.verdi@email.it", cellulare: "+39 347 9876543", budget: 320000, professione: "Investitore"},
                    {nome: "Francesca", cognome: "Neri", email: "francesca.neri@email.it", cellulare: "+39 338 5551234", budget: 150000, professione: "Consulente"},
                    {nome: "Alessandro", cognome: "Gialli", email: "alessandro.gialli@email.it", cellulare: "+39 349 8887766", budget: 420000, professione: "Imprenditore"},
                    {nome: "Sofia", cognome: "Blu", email: "sofia.blu@email.it", cellulare: "+39 345 3334455", budget: 280000, professione: "Libero Professionista"},
                    {nome: "Matteo", cognome: "Viola", email: "matteo.viola@email.it", cellulare: "+39 335 6667788", budget: 190000, professione: "Commercialista"},
                    {nome: "Elena", cognome: "Arancio", email: "elena.arancio@email.it", cellulare: "+39 339 9998877", budget: 350000, professione: "Avvocato"},
                    {nome: "Davide", cognome: "Rosa", email: "davide.rosa@email.it", cellulare: "+39 348 1112233", budget: 210000, professione: "Architetto"},
                    {nome: "Chiara", cognome: "Marrone", email: "chiara.marrone@email.it", cellulare: "+39 346 4445566", budget: 280000, professione: "Medico"},
                    {nome: "Roberto", cognome: "Grigio", email: "roberto.grigio@email.it", cellulare: "+39 333 7778899", budget: 380000, professione: "Notaio"},
                    {nome: "Valeria", cognome: "Celeste", email: "valeria.celeste@email.it", cellulare: "+39 340 1112222", budget: 220000, professione: "Farmacista"},
                    {nome: "Simone", cognome: "Argento", email: "simone.argento@email.it", cellulare: "+39 347 3334444", budget: 290000, professione: "Ingegnere"},
                    {nome: "Martina", cognome: "Oro", email: "martina.oro@email.it", cellulare: "+39 338 5556666", budget: 410000, professione: "Dirigente"},
                    {nome: "Giovanni", cognome: "Bronzo", email: "giovanni.bronzo@email.it", cellulare: "+39 349 7778888", budget: 330000, professione: "Commerciante"}
                ];
                
                console.log('‚ûï Aggiunta 15 investitori ai', investitori.length, 'esistenti');
                
                // AGGIUNGI ai esistenti (non sostituire)
                investitori = [...investitori, ...datiEsempio];
                
                console.log('üíæ Salvataggio su Firebase...', investitori.length, 'investitori totali');
                await db.ref('investitori').set(investitori);
                console.log('‚úÖ Salvato su Firebase!');
                
                // RICALCOLA CAPITALE
                capitaleDisponibile = investitori.reduce((sum, inv) => sum + (inv.budget || 0), 0);
                console.log('üí∞ Nuovo capitale:', capitaleDisponibile);
                
                // AGGIORNA TUTTO
                aggiornaCounterCapitale();
                renderInvestitori();
                
                // AVVIA TOAST se non gi√† avviato
                if (!toastInterval) {
                    console.log('üéØ Avvio toast investitori...');
                    startToastInvestitori();
                }
                
                document.getElementById('invAlert').innerHTML = '<div style="background:#d4edda;color:#155724;padding:11px;border-radius:7px;margin-bottom:13px;">‚úÖ Caricati 15 investitori! Capitale totale: ‚Ç¨' + capitaleDisponibile.toLocaleString('it-IT') + '</div>';
                setTimeout(() => document.getElementById('invAlert').innerHTML = '', 3500);
            } catch (e) {
                console.error('‚ùå ERRORE:', e);
                alert('‚ùå Errore: ' + e.message);
            } finally {
                hdLd();
            }
        }

        async function aggiungiInvestitore() {
            const nome = document.getElementById('invNome').value.trim();
            const cognome = document.getElementById('invCognome').value.trim();
            const email = document.getElementById('invEmail').value.trim();
            const cellulare = document.getElementById('invCell').value.trim();
            const budget = parseInt(document.getElementById('invBudget').value) || 0;
            const professione = document.getElementById('invProf').value.trim();
            
            if (!nome || !cognome || !email || !budget) {
                alert('‚ùå Compila almeno Nome, Cognome, Email e Budget!');
                return;
            }
            
            shLd('Aggiunta investitore...');
            try {
                const nuovoInv = {nome, cognome, email, cellulare, budget, professione};
                investitori.push(nuovoInv);
                
                // SALVA SU FIREBASE
                await db.ref('investitori').set(investitori);
                
                // RICALCOLA CAPITALE
                capitaleDisponibile = investitori.reduce((sum, inv) => sum + (inv.budget || 0), 0);
                
                // AGGIORNA COUNTER VISIVO
                aggiornaCounterCapitale();
                
                // PULISCI FORM
                document.getElementById('invNome').value = '';
                document.getElementById('invCognome').value = '';
                document.getElementById('invEmail').value = '';
                document.getElementById('invCell').value = '';
                document.getElementById('invBudget').value = '';
                document.getElementById('invProf').value = '';
                
                renderInvestitori();
                document.getElementById('invAlert').innerHTML = '<div style="background:#d4edda;color:#155724;padding:11px;border-radius:7px;margin-bottom:13px;">‚úÖ Investitore aggiunto!</div>';
                setTimeout(() => document.getElementById('invAlert').innerHTML = '', 2500);
            } catch (e) {
                alert('‚ùå Errore: ' + e.message);
            } finally {
                hdLd();
            }
        }

        async function rimuoviInvestitore(idx) {
            if (!confirm('‚ö†Ô∏è Rimuovere questo investitore?')) return;
            
            shLd('Rimozione...');
            try {
                investitori.splice(idx, 1);
                await db.ref('investitori').set(investitori);
                
                // RICALCOLA CAPITALE
                capitaleDisponibile = investitori.reduce((sum, inv) => sum + (inv.budget || 0), 0);
                
                // AGGIORNA COUNTER VISIVO
                aggiornaCounterCapitale();
                
                renderInvestitori();
            } catch (e) {
                alert('‚ùå Errore: ' + e.message);
            } finally {
                hdLd();
            }
        }

        async function upFile(e) {
            const f = e.target.files[0];
            if (!f) return;
            
            shLd('Lettura Excel...');
            try {
                const d = await rdXl(f);
                const fn = f.name.toUpperCase();
                
                // RICONOSCIMENTO AUTOMATICO TIPO FILE
                let tipoFile = null;
                
                // 1. Controlla se √® INVESTITORI (dalle colonne)
                if (d.length > 0) {
                    const colonne = Object.keys(d[0]).map(k => k.toLowerCase());
                    const hasNome = colonne.some(c => c.includes('nome'));
                    const hasBudget = colonne.some(c => c.includes('budget'));
                    const hasEmail = colonne.some(c => c.includes('email'));
                    
                    if (hasNome && hasBudget && hasEmail) {
                        tipoFile = 'INVESTITORI';
                    }
                }
                
                // 2. Se non √® investitori, controlla ASTE o NPL dal nome file
                if (!tipoFile) {
                    if (fn.includes('ASTE') || fn.includes('ASTA')) {
                        tipoFile = 'ASTE';
                    } else if (fn.includes('NPL')) {
                        tipoFile = 'NPL';
                    } else {
                        // Default: prova a capire dalle colonne
                        const colonne = Object.keys(d[0]).map(k => k.toLowerCase());
                        if (colonne.some(c => c.includes('project') || c.includes('pratica') || c.includes('debitoria'))) {
                            tipoFile = 'NPL';
                        } else {
                            tipoFile = 'ASTE';
                        }
                    }
                }
                
                console.log('üîç Tipo file riconosciuto:', tipoFile);
                
                // GESTIONE IN BASE AL TIPO
                if (tipoFile === 'INVESTITORI') {
                    // CARICA INVESTITORI
                    shLd('Caricamento investitori...');
                    
                    const nuoviInv = d.map(row => ({
                        nome: row.Nome || row.nome || '',
                        cognome: row.Cognome || row.cognome || '',
                        email: row.Email || row.email || '',
                        cellulare: row.Cellulare || row.cellulare || row.Telefono || '',
                        budget: parseInt(row.Budget || row.budget || 0),
                        professione: row.Professione || row.professione || ''
                    })).filter(inv => inv.nome && inv.cognome && inv.budget > 0);
                    
                    if (nuoviInv.length === 0) {
                        throw new Error('Nessun investitore valido trovato');
                    }
                    
                    // AGGIUNGI ai esistenti
                    investitori = [...investitori, ...nuoviInv];
                    await db.ref('investitori').set(investitori);
                    
                    // RICALCOLA CAPITALE
                    capitaleDisponibile = investitori.reduce((sum, inv) => sum + (inv.budget || 0), 0);
                    aggiornaCounterCapitale();
                    
                    // AVVIA TOAST se non gi√† avviato
                    if (!toastInterval) {
                        startToastInvestitori();
                    }
                    
                    document.getElementById('upAlert').innerHTML = `<div style="background:#d4edda;color:#155724;padding:11px;border-radius:7px;margin-bottom:13px;">‚úÖ Caricati ${nuoviInv.length} INVESTITORI! Capitale: ‚Ç¨${capitaleDisponibile.toLocaleString('it-IT')}</div>`;
                    
                } else {
                    // CARICA ASTE o NPL
                    const tp = tipoFile === 'ASTE' ? 'Asta' : 'NPL';
                    d.forEach(r => r.Tipo = tp);
                    
                    shLd('Salvataggio ' + tipoFile + '...');
                    await saveFB(d);
                    
                    document.getElementById('upAlert').innerHTML = `<div style="background:#d4edda;color:#155724;padding:11px;border-radius:7px;margin-bottom:13px;">‚úÖ Caricati ${d.length} ${tipoFile}!</div>`;
                }
                
                setTimeout(() => document.getElementById('upAlert').innerHTML = '', 3500);
                
                // CHIUDI PANNELLO ADMIN dopo caricamento
                setTimeout(() => {
                    document.getElementById('adminPan').classList.add('hide');
                }, 3500);
                
            } catch (err) {
                console.error('‚ùå Errore upload:', err);
                document.getElementById('upAlert').innerHTML = '<div style="background:#f8d7da;color:#721c24;padding:11px;border-radius:7px;margin-bottom:13px;">‚ùå ' + err.message + '</div>';
            } finally {
                hdLd();
                e.target.value = '';
            }
        }

        async function upFileInv(e) {
            const f = e.target.files[0];
            if (!f) return;
            shLd('Lettura Excel Investitori...');
            try {
                const d = await rdXl(f);
                
                // Mappa colonne Excel -> struttura investitore
                const nuoviInv = d.map(row => ({
                    nome: row.Nome || row.nome || '',
                    cognome: row.Cognome || row.cognome || '',
                    email: row.Email || row.email || '',
                    cellulare: row.Cellulare || row.cellulare || row.Telefono || '',
                    budget: parseInt(row.Budget || row.budget || 0),
                    professione: row.Professione || row.professione || ''
                })).filter(inv => inv.nome && inv.cognome && inv.budget > 0);
                
                if (nuoviInv.length === 0) {
                    throw new Error('Nessun investitore valido trovato. Verifica colonne: Nome, Cognome, Budget');
                }
                
                shLd('Salvataggio investitori...');
                
                // AGGIUNGI ai esistenti
                investitori = [...investitori, ...nuoviInv];
                await db.ref('investitori').set(investitori);
                
                // RICALCOLA CAPITALE
                capitaleDisponibile = investitori.reduce((sum, inv) => sum + (inv.budget || 0), 0);
                
                // AGGIORNA COUNTER VISIVO
                aggiornaCounterCapitale();
                
                // RIAVVIA TOAST se necessario
                if (toastInterval) {
                    clearInterval(toastInterval);
                    startToastInvestitori();
                }
                
                renderInvestitori();
                document.getElementById('invAlert').innerHTML = '<div style="background:#d4edda;color:#155724;padding:11px;border-radius:7px;margin-bottom:13px;">‚úÖ Caricati ' + nuoviInv.length + ' investitori!</div>';
                setTimeout(() => document.getElementById('invAlert').innerHTML = '', 2500);
            } catch (err) {
                document.getElementById('invAlert').innerHTML = '<div style="background:#f8d7da;color:#721c24;padding:11px;border-radius:7px;margin-bottom:13px;">‚ùå ' + err.message + '</div>';
            } finally {
                hdLd();
                e.target.value = '';
            }
        }

        function rdXl(f) {
            return new Promise((ok, err) => {
                const rdr = new FileReader();
                rdr.onload = (e) => {
                    try {
                        const dt = new Uint8Array(e.target.result);
                        const wb = XLSX.read(dt, {type: 'array'});
                        const sh = wb.Sheets[wb.SheetNames[0]];
                        const js = XLSX.utils.sheet_to_json(sh, {defval: ''});
                        ok(js);
                    } catch (er) {
                        err(new Error('File non valido'));
                    }
                };
                rdr.onerror = () => err(new Error('Errore lettura'));
                rdr.readAsArrayBuffer(f);
            });
        }

        async function saveFB(newD) {
            const snap = await db.ref('data').once('value');
            const ex = snap.val();
            let all = ex ? Object.values(ex).filter(x => x) : [];
            all = [...all, ...newD];
            const upd = {};
            all.forEach((it, i) => { upd[i] = it; });
            await db.ref('data').set(upd);
            allData = all;
            popFilt();
            rend();
        }

        async function delDB() {
            if (!confirm('‚ö†Ô∏è Cancellare TUTTI i dati (Aste, NPL e Investitori)?')) return;
            shLd('Cancellazione...');
            try {
                // CANCELLA ASTE E NPL
                await db.ref('data').remove();
                allData = [];
                
                // CANCELLA INVESTITORI
                await db.ref('investitori').remove();
                investitori = [];
                capitaleDisponibile = 0;
                
                // AGGIORNA UI
                document.getElementById('sAste').textContent = '0';
                document.getElementById('sNPL').textContent = '0';
                aggiornaCounterCapitale();
                
                document.getElementById('tblBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:35px;">Database vuoto - Carica dati</td></tr>';
                document.getElementById('blurWrap').classList.add('hide');
                document.getElementById('fReg').innerHTML = '<option value="">Tutte le regioni</option>';
                document.getElementById('fCit').innerHTML = '<option value="">Tutte le citt√†</option>';
                
                hdLd();
                alert('‚úÖ Database completamente svuotato!\n\nAste: 0\nNPL: 0\nInvestitori: 0\nCapitale: ‚Ç¨0');
            } catch (e) {
                hdLd();
                alert('‚ùå Errore: ' + e.message);
            }
        }

        document.getElementById('modal').addEventListener('click', e => { if (e.target.id === 'modal') clsMod(); });
        document.getElementById('pass').addEventListener('keypress', e => { if (e.key === 'Enter') doLogin(); });
    </script>
</body>
</html>
