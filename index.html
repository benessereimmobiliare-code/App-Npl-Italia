<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard NPL & Aste Italia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* LOGIN */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* DASHBOARD */
        .dashboard {
            display: none;
            max-width: 1600px;
            margin: 0 auto;
        }

        .dashboard.active {
            display: block;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout {
            background: #f44336;
            color: white;
        }

        .btn-upload {
            background: #4CAF50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* ADMIN PANEL */
        .admin-panel {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
        }

        .admin-panel h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .admin-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f5f5ff;
            transform: translateY(-2px);
        }

        #fileInput {
            display: none;
        }

        /* STATISTICHE */
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* FILTRI AVANZATI */
        .filters-section {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
        }

        .filters-section h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .filter-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .filter-item select,
        .filter-item input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-item select:focus,
        .filter-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        /* MAPPA E LISTA */
        .content {
            display: flex;
            height: 500px;
            position: relative;
        }

        #map {
            flex: 1;
            min-width: 300px;
        }

        /* LEGENDA MAPPA */
        .map-legend {
            position: absolute;
            top: 20px;
            right: 420px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .map-legend h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
        }

        .sidebar {
            width: 400px;
            overflow-y: auto;
            border-left: 1px solid #ddd;
            background: #fafafa;
        }

        .property-card {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
        }

        .property-card:hover {
            background: #f0f4ff;
            transform: translateX(-5px);
        }

        .property-card.selected {
            background: #e6ecff;
            border-left: 4px solid #667eea;
        }

        .property-type {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .type-asta {
            background: #ffc107;
            color: #000;
        }

        .type-npl {
            background: #e74c3c;
            color: white;
        }

        .property-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .property-price {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .property-details {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        /* TABLE */
        .table-container {
            padding: 25px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-search {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            width: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: #f5f5f5;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:hover {
            background: #f9f9f9;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .btn-close {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .detail-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .detail-item label {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .detail-item .value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* LOADING */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
                height: auto;
            }
            .sidebar {
                width: 100%;
                max-height: 400px;
            }
            #map {
                height: 400px;
            }
            .map-legend {
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- LOADING -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Caricamento...</p>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>Dashboard NPL & Aste</h1>
            <div id="loginAlert"></div>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="Inserisci username">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="Inserisci password">
            </div>
            <button class="btn-login" onclick="login()">Accedi</button>
            <div style="margin-top:20px; text-align:center; font-size:12px; color:#999;">
                <p>Admin: admin / admin123 | Viewer: viewer / view2025</p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <!-- HEADER -->
            <div class="header">
                <h1>Dashboard Immobili</h1>
                <div class="header-right">
                    <span class="user-badge" id="userBadge"></span>
                    <button class="btn btn-danger hidden" id="deleteBtn" onclick="resetDatabase()">üóëÔ∏è Svuota Dati</button>
                    <button class="btn btn-upload hidden" id="uploadBtn" onclick="showUploadPanel()">Carica Excel</button>
                    <button class="btn btn-logout" onclick="logout()">Esci</button>
                </div>
            </div>

            <!-- ADMIN PANEL -->
            <div id="adminPanel" class="admin-panel hidden">
                <h2>Pannello Admin</h2>
                <div id="uploadAlert"></div>
                <div class="admin-buttons">
                    <button class="btn btn-danger" onclick="resetDatabase()" style="font-size: 16px;">üóëÔ∏è CANCELLA TUTTI I DATI</button>
                </div>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                    <h3>Carica file Excel</h3>
                    <p>Formati supportati: .xlsx, .xls</p>
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
            </div>

            <!-- STATISTICHE -->
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="statTotal">0</div>
                    <div class="stat-label">Immobili Totali</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="statAste">0</div>
                    <div class="stat-label">Aste</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="statNpl">0</div>
                    <div class="stat-label">NPL</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="statValutazione">‚Ç¨0</div>
                    <div class="stat-label">Valutazione Totale</div>
                </div>
            </div>

            <!-- FILTRI AVANZATI -->
            <div class="filters-section">
                <h3>Filtri di Ricerca</h3>
                <div class="filters-grid">
                    <div class="filter-item">
                        <label>Tipo</label>
                        <select id="filterTipo">
                            <option value="">Tutti</option>
                            <option value="asta">Aste</option>
                            <option value="npl">NPL</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Regione</label>
                        <select id="filterRegione">
                            <option value="">Tutte le regioni</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Citt√†</label>
                        <select id="filterCitta">
                            <option value="">Tutte le citt√†</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Ricerca libera</label>
                        <input type="text" id="filterSearch" placeholder="Cerca...">
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="btn btn-upload" onclick="applyFilters()">Applica Filtri</button>
                    <button class="btn btn-danger" onclick="clearFilters()">Azzera Filtri</button>
                </div>
            </div>

            <!-- MAPPA E LISTA -->
            <div class="content">
                <div id="map"></div>
                
                <!-- LEGENDA MAPPA -->
                <div class="map-legend">
                    <h4>Legenda</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffc107;"></div>
                        <span>Aste</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>NPL</span>
                    </div>
                </div>
                
                <div class="sidebar" id="propertyList"></div>
            </div>

            <!-- TABELLA DATI -->
            <div class="table-container">
                <div class="table-header">
                    <h2>Elenco Dati (<span id="recordCount">0</span>)</h2>
                    <input type="text" id="tableSearch" class="table-search" placeholder="Cerca..." onkeyup="searchTable()">
                </div>
                <div style="overflow-x: auto;">
                    <table id="dataTable">
                        <thead id="tableHead">
                            <tr><th>Nessun dato</th></tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td style="text-align: center; padding: 40px;">Carica un file Excel</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DETTAGLI -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dettaglio Record</h2>
                <button class="btn-close" onclick="closeModal()">Chiudi</button>
            </div>
            <div id="detailContent" class="detail-grid"></div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCrdoY0gxuzPdSp955NhnQBRkjRIUpdPKI",
            authDomain: "app-npl-italia.firebaseapp.com",
            databaseURL: "https://app-npl-italia-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "app-npl-italia",
            storageBucket: "app-npl-italia.firebasestorage.app",
            messagingSenderId: "299298163787",
            appId: "1:299298163787:web:4d08b7dd3273aa4dc011ce"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allData = [];
        let currentUser = null;
        let map = null;
        let markers = [];

        const users = {
            'admin': { password: 'admin123', role: 'Admin', level: 3 },
            'viewer': { password: 'view2025', role: 'Viewer', level: 2 }
        };

        const regioniCoords = {
            'Abruzzo': [42.3511, 13.3995], 'Basilicata': [40.6389, 15.8056],
            'Calabria': [38.9100, 16.5987], 'Campania': [40.8333, 14.2500],
            'Emilia-Romagna': [44.4949, 11.3426], 'Friuli-Venezia Giulia': [45.6361, 13.8042],
            'Lazio': [41.9028, 12.4964], 'Liguria': [44.4056, 8.9463],
            'Lombardia': [45.4642, 9.1900], 'Marche': [43.6167, 13.5167],
            'Molise': [41.5611, 14.6681], 'Piemonte': [45.0703, 7.6869],
            'Puglia': [41.1171, 16.8719], 'Sardegna': [40.1209, 9.0129],
            'Sicilia': [38.1157, 13.3615], 'Toscana': [43.7711, 11.2486],
            'Trentino-Alto Adige': [46.0664, 11.1257], 'Umbria': [42.9388, 12.6137],
            'Valle d\'Aosta': [45.7372, 7.3206], 'Veneto': [45.4408, 12.3155]
        };

        function showLoading(text = 'Caricamento...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showAlert(id, message, type = 'info') {
            const el = document.getElementById(id);
            el.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }

        function login() {
            const username = document.getElementById('username').value.toLowerCase().trim();
            const password = document.getElementById('password').value;

            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    role: users[username].role,
                    level: users[username].level
                };
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('userBadge').textContent = `${currentUser.role}: ${username}`;
                
                if (currentUser.level === 3) {
                    document.getElementById('uploadBtn').classList.remove('hidden');
                    document.getElementById('deleteBtn').classList.remove('hidden');
                }
                
                loadData();
            } else {
                showAlert('loginAlert', 'Credenziali errate', 'error');
            }
        }

        function logout() {
            currentUser = null;
            allData = [];
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        async function loadData() {
            showLoading('Caricamento dati...');
            try {
                const snapshot = await db.ref('data').once('value');
                const data = snapshot.val();

                if (data) {
                    allData = Array.isArray(data) ? data : Object.values(data);
                    
                    // Determina tipo dalla colonna "Tipo" se esiste, altrimenti da "Destinazione d'uso"
                    allData = allData.map(item => {
                        // Prima cerca la colonna "Tipo"
                        const tipoCol = Object.keys(item).find(k => /^tipo$/i.test(k));
                        if (tipoCol && item[tipoCol]) {
                            const tipoValue = String(item[tipoCol]).toLowerCase();
                            item.tipo = tipoValue.includes('asta') ? 'asta' : 'npl';
                        } else {
                            // Se non c'√® "Tipo", cerca in "Destinazione d'uso"
                            const destCol = Object.keys(item).find(k => /destinazione.*uso|tipologia/i.test(k));
                            if (destCol) {
                                const dest = String(item[destCol]).toLowerCase();
                                item.tipo = (dest.includes('asta') || dest.includes('aste')) ? 'asta' : 'npl';
                            } else {
                                item.tipo = 'npl';
                            }
                        }
                        return item;
                    });
                    
                    populateFilters();
                    renderAll();
                }
            } catch (error) {
                console.error('Errore:', error);
            } finally {
                hideLoading();
            }
        }

        function populateFilters() {
            // Regioni
            const regioneCol = Object.keys(allData[0] || {}).find(k => /regione/i.test(k));
            if (regioneCol) {
                const regioni = [...new Set(allData.map(d => d[regioneCol]).filter(Boolean))].sort();
                const select = document.getElementById('filterRegione');
                select.innerHTML = '<option value="">Tutte le regioni</option>' +
                    regioni.map(r => `<option value="${r}">${r}</option>`).join('');
            }
            
            // Citt√† (estratte dall'indirizzo)
            const indirizzoCol = Object.keys(allData[0] || {}).find(k => /indirizzo/i.test(k));
            if (indirizzoCol) {
                const citta = new Set();
                allData.forEach(d => {
                    const comune = extractComuneFromAddress(d[indirizzoCol]);
                    if (comune) citta.add(comune);
                });
                const cittaArr = [...citta].sort();
                const select = document.getElementById('filterCitta');
                select.innerHTML = '<option value="">Tutte le citt√†</option>' +
                    cittaArr.map(c => `<option value="${c}">${c}</option>`).join('');
            }
        }

        function extractComuneFromAddress(address) {
            if (!address) return null;
            
            let match = address.match(/\d{5}\s+([A-Za-z\s]+)\s*\(/);
            if (match) return match[1].trim();
            
            match = address.match(/([A-Za-z\s]+)\s*\([A-Z]{2}\)/);
            if (match) return match[1].trim();
            
            const words = address.split(/[,\s]+/);
            for (let i = words.length - 1; i >= 0; i--) {
                if (words[i].match(/^[A-Z][a-z]+$/)) {
                    return words[i];
                }
            }
            
            return null;
        }

        function applyFilters() {
            renderAll();
        }

        function clearFilters() {
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterRegione').value = '';
            document.getElementById('filterCitta').value = '';
            document.getElementById('filterSearch').value = '';
            renderAll();
        }

        function getFilteredData() {
            let filtered = [...allData];
            
            const tipo = document.getElementById('filterTipo').value;
            if (tipo) {
                filtered = filtered.filter(d => d.tipo === tipo);
            }
            
            const regione = document.getElementById('filterRegione').value;
            if (regione) {
                const regioneCol = Object.keys(allData[0] || {}).find(k => /regione/i.test(k));
                if (regioneCol) {
                    filtered = filtered.filter(d => d[regioneCol] === regione);
                }
            }
            
            const citta = document.getElementById('filterCitta').value;
            if (citta) {
                const indirizzoCol = Object.keys(allData[0] || {}).find(k => /indirizzo/i.test(k));
                if (indirizzoCol) {
                    filtered = filtered.filter(d => extractComuneFromAddress(d[indirizzoCol]) === citta);
                }
            }
            
            const search = document.getElementById('filterSearch').value.toLowerCase();
            if (search) {
                filtered = filtered.filter(d =>
                    Object.values(d).some(v => String(v).toLowerCase().includes(search))
                );
            }
            
            return filtered;
        }

        function renderAll() {
            const filtered = getFilteredData();
            updateStats();
            renderMap(filtered);
            renderList(filtered);
            renderTable(filtered);
        }

        function updateStats() {
            const asteCount = allData.filter(d => d.tipo === 'asta').length;
            const nplCount = allData.filter(d => d.tipo === 'npl').length;
            
            document.getElementById('statTotal').textContent = allData.length;
            document.getElementById('statAste').textContent = asteCount;
            document.getElementById('statNpl').textContent = nplCount;
            
            // Calcola valore totale
            let valTotal = 0;
            allData.forEach(item => {
                let prezzo = null;
                
                if (item.tipo === 'asta') {
                    // ASTE: Prezzo base d'asta
                    const col = Object.keys(item).find(k => /prezzo.*base.*asta/i.test(k));
                    if (col) prezzo = item[col];
                } else {
                    // NPL: Situazione debitoria
                    const col = Object.keys(item).find(k => /situazione.*debitoria/i.test(k));
                    if (col) prezzo = item[col];
                }
                
                if (prezzo) {
                    // Estrai numero da "‚Ç¨ 80.000,00"
                    let val = String(prezzo).replace(/[‚Ç¨.\s]/g, '').replace(',', '.');
                    const numVal = parseFloat(val);
                    if (!isNaN(numVal)) {
                        valTotal += numVal;
                    }
                }
            });
            
            document.getElementById('statValutazione').textContent = '‚Ç¨' + Math.round(valTotal).toLocaleString('it-IT');
        }

        function renderMap(data) {
            if (!map) {
                map = L.map('map').setView([42.5, 12.5], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);
            }
            
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Raggruppa per coordinate gi√† salvate
            const groups = {};
            
            data.forEach((item, idx) => {
                if (item.lat && item.lng) {
                    // Usa coordinate salvate
                    const key = `${item.lat.toFixed(3)}_${item.lng.toFixed(3)}`;
                    if (!groups[key]) {
                        groups[key] = {
                            coords: [item.lat, item.lng],
                            items: []
                        };
                    }
                    groups[key].items.push({...item, idx});
                } else {
                    // Fallback: se non ha coordinate, usa comune dalla cache statica
                    const comuneCol = Object.keys(item).find(k => /comune/i.test(k));
                    const comune = comuneCol ? item[comuneCol] : null;
                    
                    // Coordinate statiche principali citt√† italiane
                    const cittaCoords = {
                        'Roma': [41.9028, 12.4964], 'Milano': [45.4642, 9.1900],
                        'Napoli': [40.8518, 14.2681], 'Torino': [45.0703, 7.6869],
                        'Genova': [44.4056, 8.9463], 'Bologna': [44.4949, 11.3426],
                        'Firenze': [43.7696, 11.2558], 'Palermo': [38.1157, 13.3615]
                    };
                    
                    if (comune && cittaCoords[comune]) {
                        const key = comune;
                        if (!groups[key]) {
                            groups[key] = {
                                coords: cittaCoords[comune],
                                items: []
                            };
                        }
                        groups[key].items.push({...item, idx});
                    }
                }
            });
            
            // Crea marker per ogni gruppo
            for (const [key, group] of Object.entries(groups)) {
                const items = group.items;
                const coords = group.coords;
                
                const aste = items.filter(i => i.tipo === 'asta').length;
                const npl = items.filter(i => i.tipo === 'npl').length;
                const color = aste > npl ? '#ffc107' : '#e74c3c';
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background: ${color};
                        color: white;
                        border-radius: 50%;
                        width: ${Math.min(50, 25 + items.length * 2)}px;
                        height: ${Math.min(50, 25 + items.length * 2)}px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        border: 3px solid white;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        font-size: 12px;
                    ">${items.length}</div>`
                });
                
                const marker = L.marker(coords, {icon}).addTo(map);
                
                // Popup con info
                const comuneCol = Object.keys(items[0]).find(k => /comune/i.test(k));
                const comuneNome = comuneCol && items[0][comuneCol] ? items[0][comuneCol] : 'Zona';
                
                let popup = `<div style="max-width: 300px; max-height: 400px; overflow-y: auto;">`;
                popup += `<h3 style="color: #667eea;">${comuneNome}</h3>`;
                popup += `<p><strong>Aste:</strong> ${aste} | <strong>NPL:</strong> ${npl}</p><hr>`;
                
                items.slice(0, 10).forEach(item => {
                    const idCol = Object.keys(item).find(c => /project.*id/i.test(c));
                    const id = idCol ? item[idCol] : '-';
                    const icona = item.tipo === 'asta' ? 'üî®' : 'üìã';
                    
                    let prezzo = 'N/D';
                    if (item.tipo === 'asta') {
                        const pCol = Object.keys(item).find(c => /prezzo.*base/i.test(c));
                        if (pCol && item[pCol]) prezzo = item[pCol];
                    } else {
                        const dCol = Object.keys(item).find(c => /situazione.*debitoria/i.test(c));
                        if (dCol && item[dCol]) prezzo = item[dCol];
                    }
                    
                    popup += `<div style="cursor:pointer; padding:8px; background:#f5f5f5; margin:5px 0; border-radius:5px; border-left: 3px solid ${item.tipo === 'asta' ? '#ffc107' : '#e74c3c'};" onclick="showDetail(${item.idx})">${icona} ${id}<br><small>${prezzo}</small></div>`;
                });
                
                if (items.length > 10) {
                    popup += `<div style="text-align:center; color:#999; margin-top:10px;">...altri ${items.length - 10}</div>`;
                }
                
                popup += `</div>`;
                marker.bindPopup(popup);
                markers.push(marker);
            }
            
            // Auto-zoom
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function renderList(data) {
            const list = document.getElementById('propertyList');
            if (data.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">Nessun risultato</div>';
                return;
            }
            
            list.innerHTML = data.map((item, idx) => {
                const idCol = Object.keys(item).find(c => /project.*id/i.test(c));
                const indirizzoCol = Object.keys(item).find(c => /indirizzo/i.test(c));
                
                const id = idCol ? item[idCol] : '-';
                const indirizzo = indirizzoCol ? item[indirizzoCol] : '-';
                
                // Leggi il prezzo dalla colonna corretta
                let prezzoValore = 'N/D';
                if (item.tipo === 'asta') {
                    // Per ASTE: Prezzo base d'asta
                    const prezzoCol = Object.keys(item).find(c => /prezzo.*base.*asta/i.test(c));
                    if (prezzoCol && item[prezzoCol]) {
                        prezzoValore = item[prezzoCol];
                    }
                } else {
                    // Per NPL: Situazione debitoria
                    const debCol = Object.keys(item).find(c => /situazione.*debitoria/i.test(c));
                    if (debCol && item[debCol]) {
                        prezzoValore = item[debCol];
                    }
                }
                
                const icona = item.tipo === 'asta' ? 'üî®' : 'üìã';
                
                return `
                    <div class="property-card" onclick="showDetail(${idx})">
                        <div class="property-type type-${item.tipo}">
                            ${icona} ${item.tipo === 'asta' ? 'ASTA' : 'NPL'}
                        </div>
                        <div class="property-title">ID: ${id}</div>
                        <div class="property-price">${prezzoValore}</div>
                        <div class="property-details">${indirizzo}</div>
                    </div>
                `;
            }).join('');
        }

        function renderTable(data) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                thead.innerHTML = '<tr><th>Nessun dato</th></tr>';
                tbody.innerHTML = '<tr><td style="text-align:center; padding:40px;">Nessun risultato</td></tr>';
                document.getElementById('recordCount').textContent = '0';
                return;
            }
            
            // Colonne da mostrare (con Prezzo base d'asta e Situazione debitoria)
            const colsToShow = ['Tipo', 'Project ID', 'Numero Pratica / NDG', 'Titolo', 'Prezzo base d\'asta', 'Situazione debitoria', 'Indirizzo', 'Comune', 'Provincia', 'CAP', 'Regione'];
            const cols = Object.keys(data[0]).filter(k => colsToShow.some(c => c.toLowerCase() === k.toLowerCase()));
            
            thead.innerHTML = '<tr>' + cols.map(c => `<th>${c}</th>`).join('') + '<th>Azioni</th></tr>';
            
            tbody.innerHTML = data.map((item, idx) => {
                const icona = item.tipo === 'asta' ? 'üî®' : 'üìã';
                const row = cols.map(col => {
                    let val = item[col] || '-';
                    if (col.toLowerCase().includes('tipo')) {
                        return `<td><span class="property-type type-${item.tipo}">${icona} ${val.toUpperCase()}</span></td>`;
                    }
                    return `<td>${val}</td>`;
                }).join('');
                return `<tr>${row}<td><button class="btn btn-upload" style="padding:6px 12px; font-size:12px;" onclick="showDetail(${idx})">Dettagli</button></td></tr>`;
            }).join('');
            
            document.getElementById('recordCount').textContent = data.length;
        }

        function searchTable() {
            const term = document.getElementById('tableSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
            });
        }

        function showDetail(idx) {
            const filtered = getFilteredData();
            const item = filtered[idx];
            const content = document.getElementById('detailContent');
            
            content.innerHTML = Object.keys(item).filter(k => k !== 'idx').map(key => `
                <div class="detail-item">
                    <label>${key}</label>
                    <div class="value">${item[key] || '-'}</div>
                </div>
            `).join('');
            
            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function showUploadPanel() {
            document.getElementById('adminPanel').classList.toggle('hidden');
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading('Lettura Excel...');
            try {
                const data = await readExcel(file);
                if (data && data.length > 0) {
                    showLoading('Salvataggio...');
                    await saveToFirebase(data);
                    showAlert('uploadAlert', `Caricati ${data.length} record`, 'success');
                }
            } catch (error) {
                showAlert('uploadAlert', 'Errore: ' + error.message, 'error');
            } finally {
                hideLoading();
                event.target.value = '';
            }
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        const cleaned = jsonData.map(row => {
                            const newRow = {};
                            for (let key in row) {
                                const cleanKey = String(key).replace(/[.#$\/\[\]]/g, '_');
                                newRow[cleanKey] = row[key];
                            }
                            
                            // Determina tipo dalla colonna "Tipo" se esiste
                            const tipoCol = Object.keys(newRow).find(k => /^tipo$/i.test(k));
                            if (tipoCol && newRow[tipoCol]) {
                                const tipoValue = String(newRow[tipoCol]).toLowerCase();
                                newRow.tipo = tipoValue.includes('asta') ? 'asta' : 'npl';
                            } else {
                                // Fallback su Destinazione d'uso
                                const destCol = Object.keys(newRow).find(k => /destinazione.*uso|tipologia/i.test(k));
                                if (destCol) {
                                    const dest = String(newRow[destCol]).toLowerCase();
                                    newRow.tipo = (dest.includes('asta') || dest.includes('aste')) ? 'asta' : 'npl';
                                } else {
                                    newRow.tipo = 'npl';
                                }
                            }
                            
                            return newRow;
                        });
                        
                        resolve(cleaned);
                    } catch (err) {
                        reject(new Error('File non valido'));
                    }
                };
                reader.onerror = () => reject(new Error('Errore lettura'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function saveToFirebase(newData) {
            console.log(`Salvataggio ${newData.length} record senza geocoding (sar√† fatto dopo)...`);
            
            // SALTA GEOCODING PER ORA - troppo lento
            // Lo faremo in background dopo il caricamento
            
            // Salva in blocchi di 500 per evitare blocchi
            const snapshot = await db.ref('data').once('value');
            const existing = snapshot.val();
            let allRecords = existing ? Object.values(existing) : [];
            
            // Aggiungi nuovi dati
            allRecords = [...allRecords, ...newData];
            
            // Salva in blocchi
            const CHUNK_SIZE = 500;
            await db.ref('data').remove(); // Pulisci prima
            
            for (let i = 0; i < allRecords.length; i += CHUNK_SIZE) {
                const chunk = allRecords.slice(i, i + CHUNK_SIZE);
                console.log(`Salvataggio blocco ${Math.floor(i/CHUNK_SIZE) + 1}/${Math.ceil(allRecords.length/CHUNK_SIZE)}...`);
                
                // Salva questo blocco
                const updates = {};
                chunk.forEach((item, idx) => {
                    updates[i + idx] = item;
                });
                await db.ref('data').update(updates);
            }
            
            console.log('‚úÖ Salvataggio completato! (geocoding sar√† fatto in background)');
            allData = allRecords;
            populateFilters();
            renderAll();
            
            // Avvia geocoding in background DOPO aver mostrato i dati
            setTimeout(() => geocodeInBackground(), 2000);
        }
        
        async function geocodeInBackground() {
            console.log('Inizio geocoding in background...');
            let updated = 0;
            
            for (let i = 0; i < allData.length; i++) {
                const item = allData[i];
                
                if (item.lat && item.lng) continue;
                
                const comuneCol = Object.keys(item).find(k => /comune/i.test(k));
                const comune = comuneCol && item[comuneCol] ? item[comuneCol] : null;
                
                if (comune && comune !== 'nan') {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(comune)}&country=Italy&format=json&limit=1`);
                        const data = await response.json();
                        if (data && data.length > 0) {
                            item.lat = parseFloat(data[0].lat);
                            item.lng = parseFloat(data[0].lon);
                            updated++;
                            
                            // Salva ogni 50 record
                            if (updated % 50 === 0) {
                                await db.ref(`data/${i}`).update({lat: item.lat, lng: item.lng});
                                console.log(`Geocoding background: ${updated} coordinate trovate`);
                                renderMap(applyFilters()); // Aggiorna mappa progressivamente
                            }
                        }
                    } catch (error) {
                        // Ignora errori
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            console.log(`‚úÖ Geocoding completato: ${updated} coordinate aggiunte`);
        }

        async function resetDatabase() {
            if (currentUser.level !== 3 || !confirm('Sei sicuro di voler cancellare TUTTI i dati?')) return;
            showLoading('Cancellazione...');
            await db.ref('data').remove();
            allData = [];
            renderAll();
            showAlert('uploadAlert', 'Database cancellato', 'success');
            hideLoading();
        }

        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });

        db.ref('data').on('value', (snapshot) => {
            if (currentUser && snapshot.exists()) {
                const data = snapshot.val();
                allData = Array.isArray(data) ? data : Object.values(data);
                allData = allData.map(item => {
                    // Prima cerca la colonna "Tipo"
                    const tipoCol = Object.keys(item).find(k => /^tipo$/i.test(k));
                    if (tipoCol && item[tipoCol]) {
                        const tipoValue = String(item[tipoCol]).toLowerCase();
                        item.tipo = tipoValue.includes('asta') ? 'asta' : 'npl';
                    } else {
                        // Fallback su Destinazione d'uso
                        const destCol = Object.keys(item).find(k => /destinazione.*uso|tipologia/i.test(k));
                        if (destCol) {
                            const dest = String(item[destCol]).toLowerCase();
                            item.tipo = (dest.includes('asta') || dest.includes('aste')) ? 'asta' : 'npl';
                        } else {
                            item.tipo = 'npl';
                        }
                    }
                    return item;
                });
                populateFilters();
                renderAll();
            }
        });
    </script>
</body>
</html>
