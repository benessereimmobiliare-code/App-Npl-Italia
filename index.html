<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceleratore Immobiliare - FREE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .nav-levels {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-bottom: 3px solid #667eea;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            position: relative;
        }
        .logo {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }
        .levels-menu { display: flex; gap: 15px; flex-wrap: wrap; }
        .level-btn {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 12px;
            background: #f8f9fa; cursor: pointer; transition: all 0.3s; position: relative;
        }
        .level-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .level-btn.active { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border-color: #4CAF50; }
        .level-btn.locked:hover { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .level-icon { font-size: 1.3em; }
        .level-name { font-weight: 700; font-size: 0.9em; }
        .level-status { font-size: 0.75em; padding: 3px 8px; background: rgba(255,255,255,0.3); border-radius: 10px; }
        .level-badge { font-size: 0.75em; font-weight: 700; padding: 3px 8px; background: rgba(255,255,255,0.9); border-radius: 10px; color: #000; }
        .container { max-width: 1400px; margin: 20px auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 30px; background: #f8f9fa; border-bottom: 3px solid #667eea; }
        .stat-card { text-align: center; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat-number { font-size: 3em; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { color: #666; margin-top: 10px; font-weight: 600; }
        .affari-section { padding: 50px 30px; background: linear-gradient(135deg, #1a237e 0%, #283593 100%); color: white; }
        .affari-content { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 2fr 1fr; gap: 40px; align-items: center; }
        @media (max-width: 768px) { .affari-content { grid-template-columns: 1fr; } }
        .affari-text h2 { font-size: 2.5em; margin-bottom: 20px; }
        .affari-benefits { list-style: none; margin: 25px 0; }
        .affari-benefits li { padding: 12px 0; font-size: 1.1em; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .btn-affari { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; padding: 18px 40px; border: none; border-radius: 50px; font-size: 1.3em; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(255,215,0,0.4); transition: all 0.3s; margin-top: 20px; }
        .btn-affari:hover { transform: scale(1.1); box-shadow: 0 12px 30px rgba(255,215,0,0.6); }
        /* filters */
        .filter-wrap { padding:40px 30px;background:white;border-bottom:3px solid #667eea; }
        .courses-section { padding: 40px 30px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .course-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: all 0.3s; cursor: pointer; }
        .course-card:hover { transform: translateY(-10px); box-shadow: 0 12px 30px rgba(0,0,0,0.25); }
        .course-thumb { background: linear-gradient(135deg, #667eea, #764ba2); height: 180px; display: flex; align-items: center; justify-content: center; font-size: 4em; }
        .badge-free { display:inline-block;background:#4CAF50;color:#fff;padding:5px 15px;border-radius:20px;font-size:12px;font-weight:700;margin-top:10px; }
        .table-section { padding: 40px 30px; }
        table { width:100%; border-collapse: collapse; background:white; border-radius:10px; overflow:hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        thead { background: linear-gradient(135deg, #667eea, #764ba2); color:white; }
        th,td { padding:15px; text-align:left; }
        tbody tr:hover { background:#f8f9fa; }
        .blur-overlay { position:absolute; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.7); display:flex; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .unlock-btn { background: linear-gradient(135deg, #FFD700, #FFA500); color:#000; padding:12px 30px; border:none; border-radius:25px; font-weight:700; cursor:pointer; font-size:14px; box-shadow:0 4px 12px rgba(0,0,0,0.2); transition:all 0.3s; }
        .cta-section { padding: 60px 30px; background: linear-gradient(135deg, #667eea, #764ba2); color:white; text-align:center; }
        .cta-btn-big { background:#FFD700; color:#000; padding:20px 50px; border:none; border-radius:50px; font-size:1.5em; font-weight:700; cursor:pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.3); transition: all 0.3s; }
        .footer { padding: 30px; background: #2c3e50; color: white; text-align: center; }
        /* Modali & Login */
        .upgrade-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:200; align-items:center; justify-content:center; padding:20px; }
        .upgrade-modal.active { display:flex; }
        .modal-box { background:white; padding:40px; border-radius:20px; max-width:600px; width:100%; text-align:center; }
        #loginScreen { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index:10000; align-items:center; justify-content:center; padding:20px; }
        #loginScreen.hidden { display:none; }
        .login-box { background:white; padding:40px; border-radius:20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width:100%; }
        .login-box h1 { color:#667eea; margin-bottom: 30px; text-align:center; font-size:1.8em; }
        .login-input-group { margin-bottom: 20px; }
        .login-input-group input { width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:16px; }
        .btn-login { width:100%; padding:14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; }
        #mainApp { display:none; }
        #mainApp.active { display:block; }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginScreen">
        <div class="login-box">
            <h1>üöÄ Acceleratore Immobiliare</h1>
            <div id="loginAlert"></div>
            <div class="login-input-group">
                <label>Username</label>
                <input type="text" id="usernameLogin" placeholder="Inserisci username" autocomplete="username">
            </div>
            <div class="login-input-group">
                <label>Password</label>
                <input type="password" id="passwordLogin" placeholder="Inserisci password" autocomplete="current-password">
            </div>
            <button class="btn-login" onclick="performLogin()">Accedi</button>
        </div>
    </div>

    <!-- APP -->
    <div id="mainApp">
        <div class="nav-levels">
            <div class="nav-container">
                <div class="logo">üöÄ Acceleratore Immobiliare</div>
                <button onclick="openAdminPanel()" style="position:absolute;right:20px;top:15px;padding:8px 16px;background:#FF5722;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px;">üîë ADMIN</button>
                <div class="levels-menu">
                    <button class="level-btn active"><span class="level-icon">‚úì</span><span class="level-name">Area FREE</span><span class="level-status">Attivo</span></button>
                    <button class="level-btn locked" onclick="showUpgradeModal('premium')"><span class="level-icon">üîí</span><span class="level-name">Area Premium</span><span class="level-badge">UPGRADE</span></button>
                    <button class="level-btn locked" onclick="showUpgradeModal('soci')"><span class="level-icon">üîí</span><span class="level-name">Progetto 100 Soci</span><span class="level-badge">VIP</span></button>
                    <button class="level-btn locked" onclick="showUpgradeModal('esperti')"><span class="level-icon">üí∞</span><span class="level-name">Area Esperti</span><span class="level-badge">PRO</span></button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="header">
                <h1>üöÄ Acceleratore Immobiliare</h1>
                <p>Accelera i tuoi risultati in Aste e NPL - Da zero a PRO</p>
            </div>

            <div class="stats">
                <div class="stat-card"><div class="stat-number" id="statAste">0</div><div class="stat-label">üî® Aste Attive</div></div>
                <div class="stat-card"><div class="stat-number" id="statNpl">0</div><div class="stat-label">üìã NPL Disponibili</div></div>
                <div class="stat-card"><div class="stat-number" id="statPremium">247</div><div class="stat-label">‚≠ê Utenti Premium</div></div>
                <div class="stat-card"><div class="stat-number" id="statEsperti">38</div><div class="stat-label">üíº Esperti Attivi</div></div>
                <div class="stat-card"><div class="stat-number" id="statCapitale">‚Ç¨4.2M</div><div class="stat-label">üí∞ Capitale Disponibile</div></div>
            </div>

            <div class="affari-section">
                <div class="affari-content">
                    <div class="affari-text">
                        <h2>üíº Affari Pronti</h2>
                        <p style="font-size:1.15em;line-height:1.7;margin-bottom:25px;">
                            <strong>Sei un investitore super impegnato dalla mattina alla sera</strong> ma vuoi sfruttare le capacit√† degli iscritti all'<strong>Area Esperti</strong> del nostro Acceleratore?
                        </p>
                        <p style="font-size:1.1em;line-height:1.7;margin-bottom:25px;">
                            Usufruirai a <strong>costo zero</strong> del <strong>"Servizio Selezione Esperti Investitori Immobiliari"</strong> con:
                        </p>
                        <ul class="affari-benefits">
                            <li>‚úì <strong>Analisi accurata del titolare esperto</strong></li>
                            <li>‚úì <strong>Rating verificato</strong></li>
                            <li>‚úì <strong>Analisi regole di ingaggio</strong></li>
                            <li>‚úì <strong>Messa in contatto diretto investitore-esperto</strong></li>
                        </ul>
                        <button class="btn-affari" onclick="showFormInvestitori()">üìã COMPILA IL QUESTIONARIO</button>
                        <div style="background:rgba(255,255,255,0.15);padding:15px;border-radius:10px;margin-top:25px;font-size:0.95em;line-height:1.6;border-left:4px solid rgba(255,255,255,0.5);">
                            <strong>‚ÑπÔ∏è IMPORTANTE:</strong> Questo <strong>NON √® un servizio di investimento</strong>, ma esclusivamente un <strong>servizio di messa in contatto diretto</strong> tra investitori ed esperti del settore immobiliare. <strong>Non viene richiesto nessun compenso</strong> n√© all'investitore n√© all'utente esperto.
                        </div>
                    </div>
                    <div class="affari-visual" style="text-align:center;">
                        <div style="font-size:8em;margin-bottom:20px;animation: float 3s ease-in-out infinite;">ü§ù</div>
                        <p class="affari-label" style="font-weight:700;">Investitori ‚ÜîÔ∏è Esperti</p>
                        <p style="font-size:0.9em;opacity:0.8;margin-top:10px;">Servizio gratuito di matching</p>
                    </div>
                </div>
            </div>

            <!-- Filtri -->
            <div class="filter-wrap">
                <div style="max-width:1200px;margin:0 auto;">
                    <h3 style="color:#667eea;margin-bottom:25px;font-size:1.8em;text-align:center;">üîç Filtri di Ricerca</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;margin-bottom:20px;">
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:14px;">Tipo</label>
                            <select id="filterTipo" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;background:white;">
                                <option value="">Tutti</option>
                                <option value="asta">Aste</option>
                                <option value="npl">NPL</option>
                            </select>
                        </div>
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:14px;">Regione</label>
                            <select id="filterRegione" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;background:white;">
                                <option value="">Tutte le regioni</option>
                            </select>
                        </div>
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:14px;">Citt√†</label>
                            <select id="filterCitta" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;background:white;">
                                <option value="">Tutte le citt√†</option>
                            </select>
                        </div>
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:14px;">Ricerca libera</label>
                            <input type="text" id="filterSearch" placeholder="Cerca..." style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;">
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                        <button onclick="applyFilters()" style="padding:12px 30px;background:#4CAF50;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.3s;">üîç Applica Filtri</button>
                        <button onclick="clearFilters()" style="padding:12px 30px;background:#f44336;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.3s;">‚ùå Azzera Filtri</button>
                    </div>
                </div>
            </div>

            <!-- Corsi -->
            <div class="courses-section">
                <h2 style="text-align:center;font-size:2em;margin-bottom:30px;color:#333;">üìö Corsi Gratuiti per Iniziare</h2>
                <div class="courses-grid">
                    <div class="course-card"><div class="course-thumb">üéì</div><div class="course-info" style="padding:20px;"><h3>Come Funzionano le Aste Immobiliari</h3><p>Impara le basi delle aste giudiziarie.</p><span class="badge-free">GRATIS</span></div></div>
                    <div class="course-card"><div class="course-thumb">üí∞</div><div class="course-info" style="padding:20px;"><h3>Valutare un NPL in 10 Minuti</h3><p>Metodo rapido per capire se un credito √® opportunit√† o trappola.</p><span class="badge-free">GRATIS</span></div></div>
                    <div class="course-card"><div class="course-thumb">üîç</div><div class="course-info" style="padding:20px;"><h3>5 Errori da Evitare</h3><p>Gli sbagli pi√π comuni dei principianti.</p><span class="badge-free">GRATIS</span></div></div>
                </div>
            </div>

            <!-- Tabella -->
            <div class="table-section">
                <div class="table-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;">
                    <h2>üî® Aste Disponibili (Anteprima)</h2>
                </div>
                <table>
                    <thead><tr><th>Tipo</th><th>Regione</th><th>Citt√†</th><th>Prezzo Indicativo</th><th>Data Asta</th><th>Azioni</th></tr></thead>
                    <tbody>
                        <!-- renderTable() inietter√† qui -->
                    </tbody>
                </table>
            </div>

            <div class="cta-section">
                <h2>üöÄ Passa a Premium e Sblocca TUTTO</h2>
                <p>Accedi a aste complete, indirizzi, contatti, documenti e corsi avanzati</p>
                <button class="cta-btn-big" onclick="showUpgradeModal('premium')">PROVA 7 GIORNI GRATIS</button>
                <p style="margin-top:20px;font-size:0.9em;">Poi solo ‚Ç¨97/mese - Cancella quando vuoi</p>
            </div>

            <div class="footer">
                <p>&copy; 2025 Acceleratore Immobiliare | Privacy | Termini</p>
            </div>
        </div>
    </div>

    <!-- Modali -->
    <div id="upgradeModal" class="upgrade-modal">
        <div class="modal-box">
            <h2 id="modalTitle">üîí Area Bloccata</h2>
            <p id="modalDescription">Descrizione area</p>
            <ul class="features-list" id="modalFeatures" style="text-align:left;"></ul>
            <div class="modal-buttons" style="display:flex;gap:15px;justify-content:center;margin-top:30px;">
                <button class="unlock-btn" onclick="alert('Redirect a pagina checkout')">SBLOCCA ORA</button>
                <button class="unlock-btn" style="background:#e0e0e0;color:#333;" onclick="closeUpgradeModal()">Forse pi√π tardi</button>
            </div>
        </div>
    </div>

    <div id="formInvestitoriModal" class="upgrade-modal">
        <div class="modal-box" style="max-width:700px;">
            <h2>üìã Questionario Servizio Matching Gratuito</h2>
            <form id="investitoreForm" style="text-align:left;">
                <div style="margin-bottom:20px;"><label>Nome e Cognome *</label><input type="text" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;"></div>
                <div style="margin-bottom:20px;"><label>Email *</label><input type="email" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;"></div>
                <div style="margin-bottom:20px;"><label>Telefono *</label><input type="tel" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;"></div>
                <div class="modal-buttons" style="margin-top:30px;">
                    <button type="submit" class="unlock-btn" onclick="event.preventDefault(); alert('Form inviato!'); closeFormInvestitori();">INVIA RICHIESTA</button>
                    <button type="button" class="unlock-btn" style="background:#e0e0e0;color:#333;" onclick="closeFormInvestitori()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin -->
    <div id="adminSection" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;overflow-y:auto;">
        <div style="max-width:800px;margin:50px auto;padding:30px;background:white;border-radius:15px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
                <h2 style="color:#667eea;margin:0;">üîí Area Admin</h2>
                <button onclick="closeAdminPanel()" style="padding:8px 16px;background:#e0e0e0;border:none;border-radius:6px;cursor:pointer;font-weight:700;">‚úï Chiudi</button>
            </div>
            <div style="background:#f8f9ff;padding:25px;border-radius:12px;margin-bottom:25px;border:2px solid #2196F3;">
                <h3 style="color:#2196F3;margin:0 0 15px 0;">üìä Carica Aste/NPL</h3>
                <input type="file" id="fileAsteNPL" accept=".xlsx,.xls" style="display:none;">
                <label for="fileAsteNPL" style="display:inline-block;padding:12px 25px;background:#2196F3;color:white;border-radius:8px;cursor:pointer;font-weight:700;">üìÅ Seleziona File Excel</label>
                <div id="statusAste" style="margin-top:15px;font-size:14px;"></div>
                <p style="color:#666;font-size:13px;margin:10px 0 0 0;">Ultimo aggiornamento: <span id="lastUpdateAste">Mai</span></p>
            </div>
            <div style="background:#ffe3e3;padding:25px;border-radius:12px;margin-top:25px;border:2px solid #f44336;">
                <h3 style="color:#f44336;margin:0 0 15px 0;">üóëÔ∏è Svuota Database</h3>
                <p style="color:#666;font-size:14px;margin-bottom:15px;">‚ö†Ô∏è ATTENZIONE: Questa operazione canceller√† TUTTI i dati caricati.</p>
                <button onclick="resetDatabase()" style="padding:12px 25px;background:#f44336;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;">üóëÔ∏è SVUOTA TUTTI I DATI</button>
            </div>
        </div>
    </div>

    <!-- Login logic -->
    <script>
        const AUTH_USERS = { 'user': { password: 'user2025', role: 'User', level: 1 }, 'admin': { password: 'admin2025', role: 'Admin', level: 3 } };
        let loggedUser = null;

        function performLogin() {
            const username = document.getElementById('usernameLogin').value.toLowerCase().trim();
            const password = document.getElementById('passwordLogin').value;
            const alertEl = document.getElementById('loginAlert');
            if (AUTH_USERS[username] && AUTH_USERS[username].password === password) {
                loggedUser = { username, role: AUTH_USERS[username].role, level: AUTH_USERS[username].level };
                sessionStorage.setItem('acceleratoreUser', JSON.stringify(loggedUser));
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.add('active');
                // dopo login carico i dati
                if (window.db) { loadDataFromFirebase(); }
            } else {
                alertEl.innerHTML = '<div class="login-alert login-alert-error" style="background:#f8d7da;color:#721c24;padding:12px;border-radius:8px;">‚ùå Credenziali errate!</div>';
                setTimeout(()=> alertEl.innerHTML = '', 3000);
            }
        }
        window.addEventListener('DOMContentLoaded', () => {
            const stored = sessionStorage.getItem('acceleratoreUser');
            if (stored) {
                loggedUser = JSON.parse(stored);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.add('active');
            }
            const passInput = document.getElementById('passwordLogin');
            if (passInput) passInput.addEventListener('keypress', e => { if (e.key === 'Enter') performLogin(); });
        });

        function openAdminPanel() {
            const password = prompt('Inserisci password admin:');
            if (password === 'admin2025') document.getElementById('adminSection').style.display = 'block';
            else if (password !== null) alert('‚ùå Password errata!');
        }
        function closeAdminPanel() { document.getElementById('adminSection').style.display = 'none'; }
        function showFormInvestitori(){ document.getElementById('formInvestitoriModal').classList.add('active'); }
        function closeFormInvestitori(){ document.getElementById('formInvestitoriModal').classList.remove('active'); }
        function showUpgradeModal(){ document.getElementById('upgradeModal').classList.add('active'); }
        function closeUpgradeModal(){ document.getElementById('upgradeModal').classList.remove('active'); }

        // Triplo click sul logo ‚Üí admin
        (function(){
          let clickCount=0, timer=null;
          const logo=document.querySelector('.logo');
          if(!logo) return;
          logo.addEventListener('click', ()=>{
            clickCount++; if(clickCount===3){ openAdminPanel(); clickCount=0; }
            clearTimeout(timer); timer=setTimeout(()=> clickCount=0, 1000);
          });
        })();
    </script>

    <!-- Firebase + XLSX -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- DATA ENGINE (fix counters, filters, search, reset) -->
    <script>
    /* ===== GLOBAL ===== */
    const STATS_STATIC = { premium: 247, esperti: 38, capitale: 4200000 };
    const DATA_PATH = 'dataset/items';
    let db = null;
    let allDataGlobal = [];
    let regioniSet = new Set();
    let cittaPerRegione = new Map();

    function formatCurrency(amount){ return amount>=1000000 ? '‚Ç¨'+(amount/1000000).toFixed(1)+'M' : '‚Ç¨'+amount.toLocaleString('it-IT'); }

    // Init Firebase
    window.addEventListener('load', () => { setTimeout(initializeFirebase, 300); });
    function initializeFirebase(){
      if (typeof firebase === 'undefined') return setTimeout(initializeFirebase,300);
      const firebaseConfig = {
        apiKey:"AIzaSyCrdoY0gxuzPdSp955NhnQBRkjRIUpdPKI",
        authDomain:"app-npl-italia.firebaseapp.com",
        databaseURL:"https://app-npl-italia-default-rtdb.europe-west1.firebasedatabase.app",
        projectId:"app-npl-italia",
        storageBucket:"app-npl-italia.firebasestorage.app",
        messagingSenderId:"299298163787",
        appId:"1:299298163787:web:4d08b7dd3273aa4dc011ce"
      };
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      // Se gi√† loggato ‚Üí carica dataset
      if (document.getElementById('mainApp').classList.contains('active')) loadDataFromFirebase();
      // Stats fisse
      document.getElementById('statPremium').textContent = STATS_STATIC.premium;
      document.getElementById('statEsperti').textContent = STATS_STATIC.esperti;
      document.getElementById('statCapitale').textContent = formatCurrency(STATS_STATIC.capitale);
      // Bind input file per usare handleFileUpload nuovo
      const fileAste = document.getElementById('fileAsteNPL');
      if (fileAste) fileAste.addEventListener('change', e => handleFileUpload('aste', e.target.files[0]));
    }

    /* ===== Upload Excel ‚Üí Firebase ===== */
    async function handleFileUpload(type, file){
      if (!file) return;
      const statusEl = document.getElementById('statusAste');
      const lastUpdateEl = document.getElementById('lastUpdateAste');
      statusEl.innerHTML = '<span style="color:#2196F3;">‚è≥ Lettura file...</span>';
      try {
        const rows = await parseExcel(file);
        const normalized = rows.map(normalizeRow).filter(Boolean);
        await db.ref(DATA_PATH).set(normalized);
        const now = new Date().toLocaleString('it-IT');
        statusEl.innerHTML = `<span style="color:#4CAF50;">‚úÖ Caricato ${normalized.length} record</span>`;
        lastUpdateEl.textContent = now;
        localStorage.setItem('lastUpdate_aste', now);
        await loadDataFromFirebase();
        alert('‚úÖ Dataset aggiornato. Filtri e contatori ricalcolati.');
      } catch(err){
        console.error(err); statusEl.innerHTML = `<span style="color:#f44336;">‚ùå Errore: ${err.message}</span>`;
      } finally {
        document.getElementById('fileAsteNPL').value='';
      }
    }

    function parseExcel(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>{
          try{
            const data=new Uint8Array(e.target.result);
            const wb=XLSX.read(data,{type:'array'});
            const ws=wb.Sheets[wb.SheetNames[0]];
            const json=XLSX.utils.sheet_to_json(ws,{defval:''});
            resolve(json);
          }catch(err){ reject(err); }
        };
        reader.onerror=reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function normalizeRow(r){
      const tipoRaw=(r.Tipo||r.tipo||'').toString().trim().toLowerCase();
      const tipo= tipoRaw.includes('npl') ? 'npl' : 'asta';
      const regione=(r.Regione||r.Reg||r.regione||'').toString().trim();
      const citta=(r['Citt√†']||r.Citta||r.citta||'').toString().trim();
      const pm=(r.PrezzoMin||r.prezzoMin||r.Min||'').toString().replace(/[^\d]/g,'');
      const px=(r.PrezzoMax||r.prezzoMax||r.Max||'').toString().replace(/[^\d]/g,'');
      const prezzoMin=pm?Number(pm):null;
      const prezzoMax=px?Number(px):null;
      let dataAsta=(r.DataAsta||r['Data Asta']||r.data||'').toString().trim();
      if (tipo==='npl') dataAsta='';
      if (!regione||!citta) return null;
      return { tipo, regione, citta, prezzoMin, prezzoMax, dataAsta };
    }

    /* ===== Load + Filters ===== */
    async function loadDataFromFirebase(){
      const snap=await db.ref(DATA_PATH).once('value');
      allDataGlobal=snap.val()||[];
      // regioni & citt√†
      regioniSet=new Set(); cittaPerRegione=new Map();
      allDataGlobal.forEach(d=>{
        regioniSet.add(d.regione);
        if(!cittaPerRegione.has(d.regione)) cittaPerRegione.set(d.regione,new Set());
        cittaPerRegione.get(d.regione).add(d.citta);
      });
      populateFilters();
      renderStats();
      renderTable(getFiltered());
      const lastAste = localStorage.getItem('lastUpdate_aste');
      if (lastAste) document.getElementById('lastUpdateAste').textContent = lastAste;
    }

    function populateFilters(){
      const selReg=document.getElementById('filterRegione');
      const selCit=document.getElementById('filterCitta');
      if (!selReg||!selCit) return;
      selReg.innerHTML = `<option value="">Tutte le regioni</option>` + Array.from(regioniSet).sort().map(r=>`<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('');
      selReg.onchange = ()=>{
        const reg=selReg.value;
        const cities= reg? Array.from(cittaPerRegione.get(reg)||[]) : [];
        selCit.innerHTML = `<option value="">Tutte le citt√†</option>` + cities.sort().map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      };
      const q=document.getElementById('filterSearch');
      if (q) q.onkeydown = e=>{ if (e.key==='Enter') applyFilters(); };
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ===== Stats ===== */
    function renderStats(){
      const aste=allDataGlobal.filter(d=>d.tipo==='asta').length;
      const npl =allDataGlobal.filter(d=>d.tipo==='npl').length;
      document.getElementById('statAste').textContent = aste.toLocaleString('it-IT');
      document.getElementById('statNpl').textContent  = npl.toLocaleString('it-IT');
    }

    /* ===== Filters + Table ===== */
    function getFiltered(){
      const tipoSel=(document.getElementById('filterTipo')?.value||'').toLowerCase();
      const regSel =document.getElementById('filterRegione')?.value||'';
      const citSel =document.getElementById('filterCitta')?.value||'';
      const q=(document.getElementById('filterSearch')?.value||'').toLowerCase().trim();
      return allDataGlobal.filter(d=>{
        if (tipoSel && d.tipo!==tipoSel) return false;
        if (regSel && d.regione!==regSel) return false;
        if (citSel && d.citta!==citSel) return false;
        if (q) {
          const hay=(d.tipo+' '+d.regione+' '+d.citta).toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });
    }
    function applyFilters(){ renderTable(getFiltered()); }
    function clearFilters(){
      if (document.getElementById('filterTipo')) document.getElementById('filterTipo').value='';
      if (document.getElementById('filterRegione')) document.getElementById('filterRegione').value='';
      if (document.getElementById('filterCitta')) document.getElementById('filterCitta').innerHTML='<option value="">Tutte le citt√†</option>';
      if (document.getElementById('filterSearch')) document.getElementById('filterSearch').value='';
      renderTable(allDataGlobal);
    }

    function renderTable(data){
      const tbody=document.querySelector('.table-section table tbody');
      if (!tbody) return;
      const top=data.slice(0,3);
      const rows=top.map(d=>{
        const badge = d.tipo==='npl' ? `<span style="background:#2196F3;color:white;padding:5px 10px;border-radius:5px;font-weight:700;">üìã NPL</span>` : `<span style="background:#FF9800;color:white;padding:5px 10px;border-radius:5px;font-weight:700;">üî® ASTA</span>`;
        const prezzo = (d.prezzoMin||d.prezzoMax) ? `‚Ç¨${(d.prezzoMin||0).toLocaleString('it-IT')} - ‚Ç¨${(d.prezzoMax||0).toLocaleString('it-IT')}` : '‚Äî';
        const dataAsta = d.dataAsta || '‚Äî';
        return `<tr><td>${badge}</td><td>${escapeHtml(d.regione)}</td><td>${escapeHtml(d.citta)}</td><td>${prezzo}</td><td>${escapeHtml(dataAsta)}</td><td><button class="unlock-btn" onclick="showUpgradeModal('premium')" style="padding:8px 20px;">üîì Dettagli Premium</button></td></tr>`;
      }).join('');
      const locked=`
        <tr style="position:relative;">
          <td colspan="6" style="padding:0;position:relative;height:300px;">
            <div style="filter:blur(8px);padding:15px;">
              <table style="width:100%;border:none;box-shadow:none;">
                ${(new Array(4)).fill(0).map(()=>'<tr><td>üîí</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà</td></tr>').join('')}
              </table>
            </div>
            <div class="blur-overlay">
              <div style="text-align:center;">
                <h3 style="color:#000;margin-bottom:20px;font-size:1.5em;">üîí Altre ${Math.max(0, data.length-3).toLocaleString('it-IT')} Aste Bloccate</h3>
                <button class="unlock-btn" style="font-size:16px;padding:15px 40px;" onclick="showUpgradeModal('premium')">Sblocca TUTTO con Premium</button>
              </div>
            </div>
          </td>
        </tr>`;
      tbody.innerHTML = rows + locked;
    }

    /* ===== Reset DB ===== */
    async function resetDatabase(){
      if (!confirm('‚ö†Ô∏è Cancellerai TUTTI i dati. Confermi?')) return;
      await db.ref(DATA_PATH).remove();
      allDataGlobal=[]; regioniSet.clear(); cittaPerRegione.clear();
      renderStats(); clearFilters(); renderTable([]);
      document.getElementById('lastUpdateAste').textContent='Mai';
      document.getElementById('statusAste').innerHTML='<span style="color:#999;">Nessun file caricato</span>';
      alert('üóëÔ∏è Database svuotato.');
    }
    </script>

<!-- ==== DROP-IN PATCH: filtri & risultati reali senza cambiare l'HTML/CSS ==== -->
<script>
window.allDataGlobal = window.allDataGlobal || [];
let __regioniSet = new Set();
let __cittaPerRegione = new Map();

function __escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function populateFiltersFromData(){
  if (!Array.isArray(allDataGlobal) || allDataGlobal.length===0) return;
  __regioniSet = new Set();
  __cittaPerRegione = new Map();
  allDataGlobal.forEach(d=>{
    __regioniSet.add(d.regione);
    if(!__cittaPerRegione.has(d.regione)) __cittaPerRegione.set(d.regione,new Set());
    __cittaPerRegione.get(d.regione).add(d.citta);
  });
  const selReg = document.getElementById('filterRegione');
  const selCit = document.getElementById('filterCitta');
  if (!selReg || !selCit) return;
  selReg.innerHTML = ['<option value=\"\">Tutte le regioni</option>']
    .concat([...__regioniSet].sort().map(r=>`<option value=\"${__escapeHtml(r)}\">${__escapeHtml(r)}</option>`)).join('');
  selReg.onchange = () => {
    const r = selReg.value;
    const cities = r ? [...(__cittaPerRegione.get(r)||[])].sort() : [];
    selCit.innerHTML = '<option value=\"\">Tutte le citt√†</option>' + cities.map(c=>`<option value=\"${__escapeHtml(c)}\">${__escapeHtml(c)}</option>`).join('');
  };
}

function getFiltered(){
  const tipoSel = (document.getElementById('filterTipo')?.value || '').toLowerCase();
  const regSel  = document.getElementById('filterRegione')?.value || '';
  const citSel  = document.getElementById('filterCitta')?.value || '';
  const q       = (document.getElementById('filterSearch')?.value || '').toLowerCase().trim();
  return (allDataGlobal||[]).filter(d=>{
    if (tipoSel && d.tipo !== tipoSel) return false;
    if (regSel  && d.regione !== regSel) return false;
    if (citSel  && d.citta !== citSel) return false;
    if (q){
      const hay = `${d.tipo} ${d.regione} ${d.citta}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });
}

function renderTableReal(data){
  const tbody = document.querySelector('.table-section table tbody');
  if (!tbody) return;
  const top = data.slice(0,3);
  const rowsHtml = top.map(d=>{
    const badge = d.tipo==='npl'
      ? `<span style=\"background:#2196F3;color:#fff;padding:5px 10px;border-radius:5px;font-weight:700;\">üìã NPL</span>`
      : `<span style=\"background:#FF9800;color:#fff;padding:5px 10px;border-radius:5px;font-weight:700;\">üî® ASTA</span>`;
    const prezzo = (d.prezzoMin||d.prezzoMax)
      ? `‚Ç¨${((d.prezzoMin||d.prezzoMax)||0).toLocaleString('it-IT')}`
      : '‚Äî';
    const dataA = d.dataAsta || '‚Äî';
    return `<tr>
      <td>${badge}</td>
      <td>${__escapeHtml(d.regione)}</td>
      <td>${__escapeHtml(d.citta)}</td>
      <td>${prezzo}</td>
      <td>${__escapeHtml(dataA)}</td>
      <td><button class=\"unlock-btn\" style=\"padding:8px 20px;\" onclick=\"showUpgradeModal && showUpgradeModal('premium')\">üîì Dettagli Premium</button></td>
    </tr>`;
  }).join('');

  const lockedBlock = `
    <tr style=\"position:relative;\">
      <td colspan=\"6\" style=\"padding:0;position:relative;height:260px;\">
        <div style=\"filter:blur(8px);padding:15px;\">
          <table style=\"width:100%;border:none;box-shadow:none;\">
            ${(new Array(4)).fill(0).map(()=>`<tr><td>üîí</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà‚ñà‚ñà</td><td>‚ñà‚ñà‚ñà‚ñà‚ñà</td></tr>`).join('')}
          </table>
        </div>
        <div class=\"blur-overlay\">
          <div style=\"text-align:center;\">
            <h3 style=\"color:#000;margin-bottom:20px;font-size:1.3em;\">üîí Altre ${Math.max(0,data.length-3).toLocaleString('it-IT')} Aste Bloccate</h3>
            <button class=\"unlock-btn\" style=\"font-size:16px;padding:12px 28px;\" onclick=\"showUpgradeModal && showUpgradeModal('premium')\">Sblocca TUTTO con Premium</button>
          </div>
        </div>
      </td>
    </tr>`;
  tbody.innerHTML = rowsHtml + lockedBlock;
}

function wireFilterButtons(){
  const buttons = Array.from(document.querySelectorAll('button'));
  const applyBtn = buttons.find(b => /applica/i.test(b.textContent) && /filtr/i.test(b.textContent));
  const clearBtn = buttons.find(b => /azzera/i.test(b.textContent)  && /filtr/i.test(b.textContent));

  if (applyBtn) applyBtn.addEventListener('click', () => {
    const res = getFiltered();
    renderTableReal(res);
  });

  if (clearBtn) clearBtn.addEventListener('click', () => {
    if (document.getElementById('filterTipo'))    document.getElementById('filterTipo').value = '';
    if (document.getElementById('filterRegione')) document.getElementById('filterRegione').value = '';
    if (document.getElementById('filterCitta'))   document.getElementById('filterCitta').innerHTML = '<option value=\"\">Tutte le citt√†</option>';
    if (document.getElementById('filterSearch'))  document.getElementById('filterSearch').value = '';
    renderTableReal(allDataGlobal);
  });

  const q = document.getElementById('filterSearch');
  if (q) q.addEventListener('keydown', e => { if (e.key==='Enter') { e.preventDefault(); const res=getFiltered(); renderTableReal(res); }});
}

(function initPatch(){
  try{
    if (Array.isArray(allDataGlobal) && allDataGlobal.length) {
      populateFiltersFromData();
      renderTableReal(allDataGlobal);
    }
    // Riwire anche dopo upload (se il codice cambia allDataGlobal)
    const oldSet = Object.getOwnPropertyDescriptor(window,'allDataGlobal')?.set;
    Object.defineProperty(window,'allDataGlobal',{
      configurable:true,
      get(){ return this.__ad || []; },
      set(v){
        this.__ad = Array.isArray(v)?v:[];
        populateFiltersFromData();
        renderTableReal(this.__ad);
        if (typeof oldSet==='function') oldSet(v);
      }
    });
    wireFilterButtons();
    console.log('üîß Patch filtri/risultati attivata');
  }catch(e){ console.warn('Patch non applicata:', e); }
})();
</script>


<script>
// ======= ROBUST IMPORT PATCH (intoccabile UI) =======
// Sostituisce parseExcel + handleFileUpload + normalizer con versioni pi√π tolleranti.
// - Trova automaticamente la riga header (anche se ci sono righe vuote sopra)
// - Accetta intestazioni: Regione/Reg, Comune/Citt√†/Localit√†, Provincia/Prov, Tipo, Prezzo base d'asta, Debitoria totale, Data Asta
// - Mostra conteggi letti/importati/scartati

async function handleFileUpload(type, file){
  if (!file) return;
  const statusEl = document.getElementById('statusAste') || document.getElementById('statusStats') || {innerHTML: ''};
  const lastUpdateEl = document.getElementById('lastUpdateAste') || document.getElementById('lastUpdateStats') || {textContent: ''};
  statusEl.innerHTML = '<span style="color:#2196F3;">‚è≥ Lettura file...</span>';
  try {
    const rows = await parseExcelRobust(file); // array di oggetti
    const total = rows.length;
    const normalized = rows.map(normalizeRowFlexible).filter(Boolean);
    const valid = normalized.length;
    const discarded = total - valid;

    // Accoda al dataset esistente
    const snap = await db.ref(DATA_PATH).once('value');
    const current = snap.val() || [];
    const merged = current.concat(normalized);
    await db.ref(DATA_PATH).set(merged);

    const now = new Date().toLocaleString('it-IT');
    statusEl.innerHTML = `<span style="color:#4CAF50;">‚úÖ Letti ${total}, importati ${valid}, scartati ${discarded} ‚Äî Totale in DB: ${merged.length}</span>`;
    lastUpdateEl.textContent = now;
    localStorage.setItem('lastUpdate_aste', now);

    // Aggiorna runtime
    if (Array.isArray(window.allDataGlobal)) {
      window.allDataGlobal = merged;
    }
    if (typeof loadDataFromFirebase === 'function') {
      try { await loadDataFromFirebase(); } catch(e){ /* se non esiste, ignoriamo */ }
    }
    alert('‚úÖ Import completato. Filtri e contatori ricalcolati.');
  } catch(err){
    console.error(err);
    statusEl.innerHTML = `<span style="color:#f44336;">‚ùå Errore: ${err.message}</span>`;
  } finally {
    const input = document.getElementById('fileAsteNPL') || document.getElementById('fileExcel');
    if (input) input.value='';
  }
}

// Trova header in modo robusto e produce array di oggetti
function parseExcelRobust(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=e=>{
      try{
        const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        // Primo tentativo: JSON diretto
        let json = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
        if (json && json.length) { resolve(json); return; }
        // Secondo tentativo: leggi come array e trova riga header
        const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:'' });
        let headerIdx = -1;
        const wanted = ['regione','comune','citt√†','citta','localit√†','localita','provincia','prov','tipo','prezzo','debitoria','data'];
        for (let i=0;i<rows.length;i++){
          const r = (rows[i]||[]).map(x=> (x||'').toString().toLowerCase().trim());
          const score = wanted.reduce((acc,w)=> acc + (r.some(c=>c.includes(w)) ? 1 : 0), 0);
          if (score >= 2) { headerIdx = i; break; }
        }
        if (headerIdx === -1) { resolve([]); return; }
        const headers = (rows[headerIdx] || []).map(h => (h||'').toString().trim() || ('col_'+Math.random().toString(36).slice(2,6)));
        const out = [];
        for (let i=headerIdx+1; i<rows.length; i++){
          const row = rows[i] || [];
          const obj = {};
          headers.forEach((h,idx)=> obj[h] = row[idx] ?? '');
          // scarta righe completamente vuote
          if (Object.values(obj).some(v => v!=='' && v!==null && typeof v!=='undefined')) out.push(obj);
        }
        resolve(out);
      }catch(err){ reject(err); }
    };
    fr.onerror=reject;
    fr.readAsArrayBuffer(file);
  });
}

// Normalizzatore flessibile per i tuoi file ASTE / NPL
function normalizeRowFlexible(r){
  const map={}; Object.keys(r).forEach(k=> map[String(k).toLowerCase().trim()] = r[k]);

  const pick=(...names)=>{
    for (const n of names){ const v = map[n.toLowerCase()]; if (v!==undefined && v!==null && v!=='') return v; }
    return '';
  };

  const tipoRaw = (pick('tipo')+'').toLowerCase();
  const tipo = tipoRaw.includes('npl') ? 'npl' : 'asta';

  const regione  = (pick('regione','reg')+'').trim();
  const comune   = (pick('comune','citt√†','citta','localit√†','localita')+'').trim();
  const prov     = (pick('provincia','prov')+'').toString().replace(/[^A-Za-z]/g,'').toUpperCase();
  const citta    = comune ? (prov ? `${comune} (${prov})` : comune) : '';

  const toNum=v=>{
    if (v===undefined || v===null) return null;
    const s=(v+'').replace(/\./g,'').replace(/,/g,'.').replace(/[^\d.]/g,'');
    return s ? Math.round(Number(s)) : null;
  };

  let prezzoMin=null, prezzoMax=null;
  if (tipo==='asta') prezzoMin = toNum(pick("prezzo base d'asta","base d'asta","prezzo base","base","prezzo base asta"));
  else prezzoMin = toNum(pick('debitoria totale','debito','importo totale'));

  let dataAsta='';
  const dRaw = pick('data asta','data');
  if (tipo==='asta' && dRaw){
    const d = new Date(dRaw);
    if (!isNaN(d)) dataAsta = [String(d.getDate()).padStart(2,'0'), String(d.getMonth()+1).padStart(2,'0'), d.getFullYear()].join('/');
    else dataAsta = (''+dRaw).trim();
  }

  if (!regione || !comune) return null;
  return { tipo, regione, citta, prezzoMin, prezzoMax, dataAsta };
}
</script>

</body>
</html>
