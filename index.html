<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Immobili</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .user-info {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            color: #667eea;
            font-size: 13px;
            line-height: 1.6;
        }

        /* DASHBOARD */
        .dashboard {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #667eea;
            font-size: clamp(20px, 4vw, 28px);
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-logout {
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-upload {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        /* ADMIN PANEL */
        .admin-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .admin-panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f5f5ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8eaff;
            border-color: #4CAF50;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        #fileInput {
            display: none;
        }

        /* STATISTICHE */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            color: #667eea;
            font-size: 28px;
            font-weight: bold;
        }

        /* FILTRI */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn-filter {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* TABELLA */
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-box {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
            max-width: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #f5f5f5;
            position: sticky;
            top: 0;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            color: #333;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:hover {
            background: #f9f9f9;
            cursor: pointer;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-residenziale {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-commerciale {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-altro {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .btn-close {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .detail-item {
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .detail-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .detail-item .value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        /* LOADING */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header {
                text-align: center;
            }

            .header-right {
                width: 100%;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 5px;
            }

            .modal-content {
                padding: 20px;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Caricamento in corso...</p>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>🏢 Dashboard Immobili</h1>
            <div id="loginAlert"></div>
            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Inserisci username" autocomplete="username">
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Inserisci password" autocomplete="current-password">
            </div>
            <button class="btn" id="loginBtn" onclick="login()">Accedi</button>
            <div class="user-info">
                <strong>Utenti di prova:</strong><br>
                <strong>Admin:</strong> admin / admin123<br>
                <strong>Manager:</strong> manager / manager123<br>
                <strong>Viewer:</strong> viewer / viewer123
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="dashboard">
        <!-- HEADER -->
        <div class="header">
            <h1>📊 Dashboard Immobili</h1>
            <div class="header-right">
                <span class="user-badge" id="userBadge"></span>
                <button class="btn-upload hidden" id="uploadBtn" onclick="showUploadPanel()">📤 Carica Excel</button>
                <button class="btn-logout" onclick="logout()">Esci</button>
            </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" class="admin-panel hidden">
            <h2>⚙️ Pannello Amministratore</h2>
            <div id="uploadAlert"></div>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-filter" style="background: #f44336;" onclick="resetDatabase()">
                    🗑️ Cancella Database (usa solo se i dati sono corrotti)
                </button>
                <button class="btn-filter" style="background: #2196F3;" onclick="checkDatabaseStatus()">
                    📊 Controlla Database
                </button>
            </div>
            
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">📁</div>
                <h3>Carica nuovo file Excel</h3>
                <p>Clicca qui o trascina il file .xlsx</p>
                <p style="color: #999; font-size: 12px; margin-top: 10px;">I nomi delle colonne verranno automaticamente puliti</p>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
        </div>

        <!-- STATISTICHE -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Totale Immobili</h3>
                <div class="value" id="statTotal">-</div>
            </div>
            <div class="stat-card">
                <h3>Valore Totale Perizie</h3>
                <div class="value" id="statValue">-</div>
            </div>
            <div class="stat-card">
                <h3>Regioni</h3>
                <div class="value" id="statRegions">-</div>
            </div>
            <div class="stat-card">
                <h3>Superficie Totale</h3>
                <div class="value" id="statArea">-</div>
            </div>
        </div>

        <!-- FILTRI -->
        <div class="filters">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Regione</label>
                    <select id="filterRegione">
                        <option value="">Tutte</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Provincia</label>
                    <select id="filterProvincia">
                        <option value="">Tutte</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tipologia</label>
                    <select id="filterTipologia">
                        <option value="">Tutte</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Comune</label>
                    <input type="text" id="filterComune" placeholder="Cerca comune...">
                </div>
            </div>
            <button class="btn-filter" onclick="applyFilters()">Applica Filtri</button>
        </div>

        <!-- TABELLA -->
        <div class="table-container">
            <div class="table-header">
                <h2>Elenco Immobili (<span id="recordCount">0</span>)</h2>
                <input type="text" id="searchBox" class="search-box" placeholder="🔍 Cerca..." onkeyup="searchTable()">
            </div>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tipologia</th>
                            <th>Descrizione</th>
                            <th>Comune</th>
                            <th>Provincia</th>
                            <th>Superficie (mq)</th>
                            <th>Valore Perizia</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                Nessun dato disponibile. Carica un file Excel per iniziare.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL DETTAGLIO -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dettaglio Immobile</h2>
                <button class="btn-close" onclick="closeModal()">Chiudi</button>
            </div>
            <div id="detailContent" class="detail-grid">
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- XLSX LIBRARY -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // CONFIGURAZIONE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCrdoY0gxuzPdSp955NhnQBRkjRIUpdPKI",
            authDomain: "app-npl-italia.firebaseapp.com",
            databaseURL: "https://app-npl-italia-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "app-npl-italia",
            storageBucket: "app-npl-italia.firebasestorage.app",
            messagingSenderId: "299298163787",
            appId: "1:299298163787:web:4d08b7dd3273aa4dc011ce"
        };

        // Inizializza Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log('✅ Firebase inizializzato correttamente');
        } catch (error) {
            console.warn('⚠️ Firebase non configurato:', error.message);
        }

        // VARIABILI GLOBALI
        let allData = [];
        let filteredData = [];
        let currentUser = null;

        // UTENTI
        const users = {
            'admin': { password: 'admin123', role: 'Admin', level: 3 },
            'manager': { password: 'manager123', role: 'Manager', level: 2 },
            'viewer': { password: 'viewer123', role: 'Viewer', level: 1 }
        };

        // ==========================================
        // FUNZIONE CRUCIALE: PULISCE I NOMI DELLE COLONNE
        // Rimuove SOLO i caratteri non validi per Firebase: . # $ / [ ]
        // NON tocca spazi, parentesi, trattini, underscore
        // ==========================================
        function cleanColumnName(name) {
            if (!name) return name;
            // Sostituisce SOLO . # $ / [ ] con underscore
            return String(name).replace(/[.#$\/\[\]]/g, '_');
        }

        // ==========================================
        // PULISCE UN INTERO OGGETTO (TUTTI I NOMI DELLE CHIAVI)
        // Usa cleanColumnName per ogni chiave
        // ==========================================
        function cleanObject(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            
            const cleanedObj = {};
            for (let key in obj) {
                const cleanKey = cleanColumnName(key);
                cleanedObj[cleanKey] = obj[key];
            }
            return cleanedObj;
        }

        // ==========================================
        // OTTIENE IL VALORE DA UN OGGETTO
        // Prova prima con il nome esatto, poi con quello pulito
        // ==========================================
        function getValue(obj, key) {
            if (!obj) return null;
            
            // Prima prova con la chiave esatta
            if (obj[key] !== undefined && obj[key] !== null) {
                return obj[key];
            }
            
            // Poi prova con la chiave pulita
            const cleanKey = cleanColumnName(key);
            if (cleanKey !== key && obj[cleanKey] !== undefined && obj[cleanKey] !== null) {
                return obj[cleanKey];
            }
            
            return null;
        }

        // UTILITY FUNCTIONS
        function showLoading(text = 'Caricamento in corso...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showAlert(elementId, message, type = 'info') {
            const alertEl = document.getElementById(elementId);
            alertEl.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertEl.innerHTML = '';
            }, 5000);
        }

        // LOGIN
        function login() {
            const username = document.getElementById('username').value.toLowerCase().trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showAlert('loginAlert', 'Inserisci username e password', 'error');
                return;
            }

            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    role: users[username].role,
                    level: users[username].level
                };
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('userBadge').textContent = `${currentUser.role}: ${username}`;
                
                if (currentUser.level === 3) {
                    document.getElementById('uploadBtn').classList.remove('hidden');
                }
                
                loadDataFromFirebase();
            } else {
                showAlert('loginAlert', 'Username o password errati!', 'error');
            }
        }

        // LOGOUT
        function logout() {
            currentUser = null;
            allData = [];
            filteredData = [];
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // ==========================================
        // CARICA DATI DA FIREBASE
        // ==========================================
        async function loadDataFromFirebase() {
            showLoading('Caricamento dati da Firebase...');
            
            try {
                if (!firebaseInitialized) {
                    console.log('Firebase non configurato');
                    hideLoading();
                    return;
                }

                const database = firebase.database();
                const snapshot = await database.ref('immobili').once('value');
                const data = snapshot.val();

                if (data) {
                    // Converti in array senza modificare i nomi delle chiavi
                    allData = Array.isArray(data) ? data : Object.values(data);
                    filteredData = [...allData];
                    initDashboard();
                    console.log(`✅ Caricati ${allData.length} immobili da Firebase`);
                } else {
                    console.log('Database Firebase vuoto');
                }
            } catch (error) {
                console.error('❌ Errore caricamento Firebase:', error);
                showAlert('loginAlert', 'Errore caricamento dati', 'error');
            } finally {
                hideLoading();
            }
        }

        // MOSTRA PANNELLO UPLOAD
        function showUploadPanel() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('hidden');
        }

        // ==========================================
        // GESTIONE UPLOAD FILE CON PULIZIA AUTOMATICA
        // ==========================================
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading('Elaborazione file Excel...');

            try {
                const data = await readExcelFile(file);
                
                if (data && data.length > 0) {
                    console.log(`✅ Letti ${data.length} record dal file Excel`);
                    
                    if (firebaseInitialized) {
                        const previousTotal = allData.length;
                        await saveToFirebase(data);
                        const newTotal = allData.length;
                        const added = newTotal - previousTotal;
                        
                        if (added > 0) {
                            showAlert('uploadAlert', `✅ File caricato! ${added} nuovi immobili aggiunti. Totale: ${newTotal}`, 'success');
                        } else {
                            showAlert('uploadAlert', `ℹ️ File caricato! Nessun nuovo immobile (tutti già presenti). Totale: ${newTotal}`, 'info');
                        }
                    } else {
                        allData = data;
                        filteredData = [...allData];
                        initDashboard();
                        showAlert('uploadAlert', `✅ File caricato! ${data.length} immobili visualizzati.`, 'success');
                    }
                } else {
                    showAlert('uploadAlert', '❌ Il file Excel è vuoto', 'error');
                }
            } catch (error) {
                console.error('❌ Errore elaborazione file:', error);
                showAlert('uploadAlert', `❌ Errore: ${error.message}`, 'error');
            } finally {
                hideLoading();
                event.target.value = '';
            }
        }

        // ==========================================
        // LEGGI FILE EXCEL E PULISCE AUTOMATICAMENTE I NOMI DELLE COLONNE
        // ==========================================
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // PULISCE automaticamente i nomi delle colonne
                        const processedData = jsonData.map(row => {
                            const cleanedRow = {};
                            for (let key in row) {
                                // PULIZIA: Rimuove caratteri non validi
                                const cleanKey = cleanColumnName(key);
                                
                                // Converti date in stringhe
                                if (row[key] instanceof Date) {
                                    cleanedRow[cleanKey] = row[key].toISOString().split('T')[0];
                                } else {
                                    cleanedRow[cleanKey] = row[key];
                                }
                            }
                            return cleanedRow;
                        });
                        
                        console.log(`✅ Colonne pulite automaticamente`);
                        resolve(processedData);
                    } catch (error) {
                        reject(new Error('Formato file non valido'));
                    }
                };
                
                reader.onerror = () => reject(new Error('Errore lettura file'));
                reader.readAsArrayBuffer(file);
            });
        }

        // SALVA SU FIREBASE - MERGE DEI DATI
        async function saveToFirebase(data) {
            try {
                const database = firebase.database();
                
                // Legge i dati esistenti
                const snapshot = await database.ref('immobili').once('value');
                const existingData = snapshot.val();
                
                let mergedData = [];
                
                if (existingData) {
                    // Converte i dati esistenti in array (senza modificarli)
                    const existingArray = Array.isArray(existingData) ? existingData : Object.values(existingData);
                    
                    // Crea una mappa degli ID esistenti per evitare duplicati
                    const existingIds = new Set(
                        existingArray.map(item => getValue(item, 'ID Asset (PBE)')).filter(Boolean)
                    );
                    
                    // Filtra i nuovi dati per rimuovere duplicati
                    const newUniqueData = data.filter(item => {
                        const id = getValue(item, 'ID Asset (PBE)');
                        return id && !existingIds.has(id);
                    });
                    
                    // Unisce i dati esistenti con i nuovi
                    mergedData = [...existingArray, ...newUniqueData];
                    
                    console.log(`📊 Dati esistenti: ${existingArray.length}`);
                    console.log(`📊 Nuovi dati unici: ${newUniqueData.length}`);
                    console.log(`📊 Totale dopo merge: ${mergedData.length}`);
                } else {
                    // Nessun dato esistente, salva tutto
                    mergedData = data;
                    console.log(`📊 Primo caricamento: ${data.length} immobili`);
                }
                
                // Salva i dati uniti
                await database.ref('immobili').set(mergedData);
                console.log('✅ Dati salvati su Firebase');
                
                // Aggiorna i dati locali
                allData = mergedData;
                filteredData = [...allData];
                initDashboard();
            } catch (error) {
                throw new Error('Errore salvataggio su Firebase: ' + error.message);
            }
        }

        // INIZIALIZZA DASHBOARD
        function initDashboard() {
            if (allData.length === 0) {
                console.log('Nessun dato da visualizzare');
                return;
            }
            populateFilters();
            updateStats();
            renderTable();
        }

        // POPOLA FILTRI
        function populateFilters() {
            const regioni = [...new Set(allData.map(d => getValue(d, 'Regione')).filter(Boolean))].sort();
            const province = [...new Set(allData.map(d => getValue(d, 'Provincia')).filter(Boolean))].sort();
            const tipologie = [...new Set(allData.map(d => getValue(d, 'Tipologia Asset')).filter(Boolean))].sort();

            const selectRegione = document.getElementById('filterRegione');
            const selectProvincia = document.getElementById('filterProvincia');
            const selectTipologia = document.getElementById('filterTipologia');

            selectRegione.innerHTML = '<option value="">Tutte</option>';
            selectProvincia.innerHTML = '<option value="">Tutte</option>';
            selectTipologia.innerHTML = '<option value="">Tutte</option>';

            regioni.forEach(r => {
                const option = document.createElement('option');
                option.value = r;
                option.textContent = r;
                selectRegione.appendChild(option);
            });

            province.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                selectProvincia.appendChild(option);
            });

            tipologie.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                selectTipologia.appendChild(option);
            });
        }

        // APPLICA FILTRI
        function applyFilters() {
            const regione = document.getElementById('filterRegione').value;
            const provincia = document.getElementById('filterProvincia').value;
            const tipologia = document.getElementById('filterTipologia').value;
            const comune = document.getElementById('filterComune').value.toLowerCase();

            filteredData = allData.filter(item => {
                let match = true;
                if (regione && getValue(item, 'Regione') !== regione) match = false;
                if (provincia && getValue(item, 'Provincia') !== provincia) match = false;
                if (tipologia && getValue(item, 'Tipologia Asset') !== tipologia) match = false;
                if (comune && !getValue(item, 'Comune')?.toLowerCase().includes(comune)) match = false;
                return match;
            });

            updateStats();
            renderTable();
        }

        // AGGIORNA STATISTICHE
        function updateStats() {
            const total = filteredData.length;
            const valoreTotale = filteredData.reduce((sum, item) => {
                return sum + (parseFloat(getValue(item, 'Valore ultima perizia terzi')) || 0);
            }, 0);
            const regioni = new Set(filteredData.map(d => getValue(d, 'Regione')).filter(Boolean)).size;
            const superficieTotale = filteredData.reduce((sum, item) => {
                return sum + (parseFloat(getValue(item, 'Superficie mq')) || 0);
            }, 0);

            document.getElementById('statTotal').textContent = total.toLocaleString('it-IT');
            document.getElementById('statValue').textContent = '€' + valoreTotale.toLocaleString('it-IT');
            document.getElementById('statRegions').textContent = regioni;
            document.getElementById('statArea').textContent = Math.round(superficieTotale).toLocaleString('it-IT') + ' mq';
        }

        // RENDERIZZA TABELLA
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            Nessun immobile trovato
                        </td>
                    </tr>
                `;
                document.getElementById('recordCount').textContent = '0';
                return;
            }

            filteredData.forEach(item => {
                const row = tbody.insertRow();
                
                let badgeClass = 'badge-altro';
                const tipologia = getValue(item, 'Tipologia Asset');
                if (tipologia?.includes('Residenziale')) badgeClass = 'badge-residenziale';
                if (tipologia?.includes('Commerciale')) badgeClass = 'badge-commerciale';

                const valore = currentUser.level >= 2 
                    ? '€' + (parseFloat(getValue(item, 'Valore ultima perizia terzi')) || 0).toLocaleString('it-IT')
                    : 'Riservato';

                const superficie = (parseFloat(getValue(item, 'Superficie mq')) || 0).toLocaleString('it-IT');
                const idAsset = getValue(item, 'ID Asset (PBE)') || '-';

                row.innerHTML = `
                    <td>${idAsset}</td>
                    <td><span class="badge ${badgeClass}">${tipologia || '-'}</span></td>
                    <td>${getValue(item, 'Descrizione asset') || '-'}</td>
                    <td>${getValue(item, 'Comune') || '-'}</td>
                    <td>${getValue(item, 'Provincia') || '-'}</td>
                    <td>${superficie} mq</td>
                    <td>${valore}</td>
                    <td><button class="btn-filter" onclick="showDetail('${idAsset}')">Dettagli</button></td>
                `;
            });

            document.getElementById('recordCount').textContent = filteredData.length;
        }

        // RICERCA TABELLA
        function searchTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(item => {
                    return Object.values(item).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                });
            }

            updateStats();
            renderTable();
        }

        // MOSTRA DETTAGLIO
        function showDetail(id) {
            const item = allData.find(d => String(getValue(d, 'ID Asset (PBE)')) === String(id));
            if (!item) return;

            const detailContent = document.getElementById('detailContent');
            detailContent.innerHTML = '';

            const fields = [
                { label: 'ID Asset', key: 'ID Asset (PBE)' },
                { label: 'ID Collateral', key: 'ID Collateral (CGA)' },
                { label: 'Tipologia', key: 'Tipologia Asset' },
                { label: 'Descrizione', key: 'Descrizione asset' },
                { label: 'Regione', key: 'Regione' },
                { label: 'Provincia', key: 'Provincia' },
                { label: 'Comune', key: 'Comune' },
                { label: 'Indirizzo', key: 'Indirizzo' },
                { label: 'Località', key: 'Localita' },
                { label: 'Superficie', key: 'Superficie mq' },
                { label: '% Proprietà', key: '% di proprieta' },
                { label: 'Tipo Diritto', key: 'Tipo diritto reale' }
            ];

            if (currentUser.level >= 2) {
                fields.push(
                    { label: 'Valore Perizia', key: 'Valore ultima perizia terzi' },
                    { label: 'Data Perizia', key: 'Data ultima perizia terzi' },
                    { label: 'Prezzo Base Asta', key: 'Prezzo base ultima asta' },
                    { label: 'Data Ultima Asta', key: 'Data ultima asta' },
                    { label: 'Aste Deserte', key: 'Numero aste deserte' },
                    { label: 'Tribunale', key: 'Tribunale asta' }
                );
            }

            fields.forEach(field => {
                const value = getValue(item, field.key);
                if (value !== null && value !== undefined && value !== '') {
                    const div = document.createElement('div');
                    div.className = 'detail-item';
                    div.innerHTML = `
                        <label>${field.label}</label>
                        <div class="value">${formatValue(value, field.key)}</div>
                    `;
                    detailContent.appendChild(div);
                }
            });

            document.getElementById('detailModal').classList.add('active');
        }

        // FORMATTA VALORE
        function formatValue(value, key) {
            if (key.includes('Valore') || key.includes('Prezzo')) {
                return '€' + parseFloat(value).toLocaleString('it-IT');
            }
            if (key.includes('Superficie')) {
                return parseFloat(value).toLocaleString('it-IT') + ' mq';
            }
            if (key.includes('%')) {
                return parseFloat(value).toLocaleString('it-IT') + '%';
            }
            return value;
        }

        // CHIUDI MODAL
        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // ==========================================
        // FUNZIONI ADMIN: RESET E CHECK DATABASE
        // ==========================================
        async function resetDatabase() {
            if (currentUser.level !== 3) {
                alert('Solo gli admin possono cancellare il database');
                return;
            }

            if (!confirm('⚠️ ATTENZIONE!\n\nQuesta operazione cancellerà TUTTI i dati dal database Firebase.\n\nSei SICURO di voler procedere?')) {
                return;
            }

            if (!confirm('ULTIMA CONFERMA:\n\nCancello definitivamente tutti i dati?\n\nQuesta operazione è IRREVERSIBILE!')) {
                return;
            }

            showLoading('Cancellazione database in corso...');

            try {
                const database = firebase.database();
                await database.ref('immobili').remove();
                
                allData = [];
                filteredData = [];
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            Database cancellato. Carica un file Excel per iniziare.
                        </td>
                    </tr>
                `;
                document.getElementById('recordCount').textContent = '0';
                updateStats();
                
                showAlert('uploadAlert', '✅ Database cancellato con successo! Ora puoi caricare un nuovo file Excel.', 'success');
                console.log('✅ Database resettato');
            } catch (error) {
                console.error('❌ Errore reset database:', error);
                showAlert('uploadAlert', '❌ Errore: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function checkDatabaseStatus() {
            showLoading('Controllo database...');

            try {
                const database = firebase.database();
                const snapshot = await database.ref('immobili').once('value');
                const data = snapshot.val();

                if (!data) {
                    showAlert('uploadAlert', '📭 Database vuoto - Pronto per caricare nuovi dati', 'info');
                    hideLoading();
                    return;
                }

                const dataArray = Array.isArray(data) ? data : Object.values(data);
                
                if (dataArray.length > 0) {
                    const firstRecord = dataArray[0];
                    const keys = Object.keys(firstRecord);
                    
                    // Verifica se le chiavi sono corrette
                    const hasCorrectKeys = keys.includes('ID Asset (PBE)') && keys.includes('Comune') && keys.includes('Superficie mq');
                    const hasCorruptedKeys = keys.some(k => k.includes('__') || k.match(/[.#$\/\[\]]/));
                    
                    let message = `📊 Database contiene ${dataArray.length} record\n\n`;
                    
                    if (hasCorruptedKeys) {
                        message += '⚠️ ATTENZIONE: Database contiene chiavi corrotte!\n';
                        message += 'Usa il pulsante "Cancella Database" e ricarica il file Excel.\n\n';
                    } else if (hasCorrectKeys) {
                        message += '✅ Database OK - Chiavi corrette\n\n';
                    }
                    
                    message += 'Prime 5 chiavi:\n' + keys.slice(0, 5).join(', ');
                    
                    alert(message);
                } else {
                    showAlert('uploadAlert', '📭 Database vuoto', 'info');
                }
            } catch (error) {
                console.error('❌ Errore controllo database:', error);
                showAlert('uploadAlert', '❌ Errore: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // EVENT LISTENERS
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });

        // Drag & Drop
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        // ASCOLTA CAMBIAMENTI IN TEMPO REALE DA FIREBASE
        if (firebaseInitialized) {
            const database = firebase.database();
            database.ref('immobili').on('value', (snapshot) => {
                if (currentUser && snapshot.exists()) {
                    const data = snapshot.val();
                    allData = Array.isArray(data) ? data : Object.values(data);
                    filteredData = [...allData];
                    initDashboard();
                    console.log('✅ Dati aggiornati automaticamente da Firebase');
                }
            });
        }
    </script>
</body>
</html>
